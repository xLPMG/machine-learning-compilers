

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. Code Generation &mdash; Machine Learning Compilers  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Tensor Operation Backend" href="05_tensor_op.html" />
    <link rel="prev" title="3. Neon" href="03_neon.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Machine Learning Compilers
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Project Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/01_project_information.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/02_project_report.html">Project Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/03_user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/04_docu_setup.html">Documentation Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Submissions</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_assembly.html">1. Assembly</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_base.html">2. Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_neon.html">3. Neon</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. Code Generation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#brgemm-primitive">4.1 BRGEMM Primitive</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#microkernel">4.1.1 Microkernel</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#instruction-generation">4.1.1.1 Instruction Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#microkernel-generation">4.1.1.2 Microkernel Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#microkernel-benchmark">4.1.1.3 Microkernel Benchmark</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gemm">4.1.2 GEMM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#implementation-of-a-gemm-kernel">4.1.2.1 Implementation of a GEMM kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#calling-the-gemm-kernel">4.1.2.2 Calling the GEMM kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verification-of-the-gemm-kernel-with-lda-m-ldb-k-ldc-m">4.1.2.3 Verification of the GEMM kernel with lda=M, ldb=K, ldc=M</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verification-of-the-gemm-kernel-with-lda-m-ldb-k-or-ldc-m">4.1.2.4 Verification of the GEMM kernel with lda&gt;M, ldb&gt;K or ldc&gt;M</a></li>
<li class="toctree-l4"><a class="reference internal" href="#benchmarking-the-gemm-kernel">4.1.2.5 Benchmarking the GEMM kernel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#batch-reduce-gemm">4.1.3 Batch-Reduce GEMM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#support-for-batch-reduce-gemms">4.1.3.1 Support for Batch-Reduce GEMMs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#calling-the-batch-reduce-gemm-kernel">4.1.3.2 Calling the Batch-Reduce GEMM kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verification-of-the-batch-reduce-gemm-kernel">4.1.3.3 Verification of the Batch-Reduce GEMM kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#benchmarking-the-batch-reduce-gemm-kernel">4.1.3.4 Benchmarking the Batch-Reduce GEMM kernel</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#unary-primitives">4.2 Unary Primitives</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#zero-primitive">4.2.1 Zero Primitive</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#zero-primitive-implementation">4.2.1.1 Zero Primitive Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#zero-primitive-benchmarks">4.2.1.1 Zero Primitive Benchmarks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#identity-primitive">4.2.2 Identity Primitive</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#identity-implementation">4.2.2.1 Identity Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#identity-transposition-implementation">4.2.2.2 Identity Transposition Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#benchmarks-the-identity-kernel-performance">4.2.2.3 Benchmarks the Identity Kernel Performance</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#relu-primitive">4.2.3 ReLU Primitive</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#relu-primitive-implementation">4.2.3.1 ReLU Primitive Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#relu-primitive-benchmarks">4.2.3.2 ReLU Primitive Benchmarks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="05_tensor_op.html">5. Tensor Operation Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_einsum.html">6. Einsum Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_individual_phase.html">7. Individual Phase</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit.html">mini_jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_benchmarks.html">mini_jit::benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_converters.html">mini_jit::converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_einsum.html">mini_jit::einsum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_instructions.html">mini_jit::instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_ir.html">mini_jit::ir</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_kernels.html">mini_jit::kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_registers.html">mini_jit::registers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Machine Learning Compilers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">4. Code Generation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/submissions/04_code_gen.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="code-generation">
<h1>4. Code Generation<a class="headerlink" href="#code-generation" title="Link to this heading"></a></h1>
<p>After developing Neon kernels for the first few weeks, we gained valuable insights into implementing different operations.
In this phase of the project, our goal was to leverage that knowledge to build the backbone of a JIT C++ code generator.
This code generator is designed to produce assembly code for arbitrary matrix dimensions and execute the generated code on our machine.</p>
<section id="brgemm-primitive">
<span id="id1"></span><h2>4.1 BRGEMM Primitive<a class="headerlink" href="#brgemm-primitive" title="Link to this heading"></a></h2>
<p>In this section, we explain how we implemented the BRGEMM primitive for our machine learning compiler.</p>
<section id="microkernel">
<span id="brgemm-microkernel"></span><h3>4.1.1 Microkernel<a class="headerlink" href="#microkernel" title="Link to this heading"></a></h3>
<p>Before we began implementing the Batch-Reduce General Matrix-Matrix Multiplication kernel, we first needed to take a look at how we could multiply matrices using the JIT C++ code generator for assembly. To simplify things, we first put our focus on generating the fixed size microkernels which we had previously implemented in A64 ARM assembly (see: <a class="reference internal" href="03_neon.html#neon"><span class="std std-ref">3. Neon</span></a>).</p>
<section id="instruction-generation">
<h4>4.1.1.1 Instruction Generation<a class="headerlink" href="#instruction-generation" title="Link to this heading"></a></h4>
<p>The first step to generating a kernel was to create C++ mappings to the A64 ARM assembly instructions we needed. That is, for each instruction we use in our assembly kernel, we require a C++ function that can generate the instruction for us, with support for various input parameters. The output of such a function is a <code class="docutils literal notranslate"><span class="pre">uint32_t</span></code> value, representing the 32-bits of the assembly instruction.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Instead of working with binary numbers directly, we decided to use hexadecimal representation.</p>
</div>
<p>While we won’t show all instructions that implemented, here are some examples:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">LDR instruction (unsigned offset)</span><a class="headerlink" href="#id6" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">* @brief Generates a base LDR (12-bit immediate) instruction using unsigned offset encoding.</span>
<span class="cm">*</span>
<span class="cm">* @param reg_dest destination register.</span>
<span class="cm">* @param reg_src source register (base address).</span>
<span class="cm">* @param imm12 12-bit immediate value.</span>
<span class="cm">*/</span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">ldr</span><span class="p">(</span><span class="n">gpr_t</span><span class="w"> </span><span class="n">reg_dest</span><span class="p">,</span>
<span class="w">                    </span><span class="n">gpr_t</span><span class="w"> </span><span class="n">reg_src</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">imm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l_ins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xB9400000</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// set size</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l_sf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg_dest</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">;</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">l_sf</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span><span class="w"> </span><span class="c1">// set bit 30</span>

<span class="w">    </span><span class="c1">// set destination register id</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">reg_dest</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// set first source register id</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">reg_src</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// check if immediate can be encoded</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">l_sf</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">imm</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">invalid_argument</span><span class="p">(</span><span class="s">&quot;Immediate offset must be a multiple of 4 (32-bit) or 8 (64-bit)&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// scale the immediate for encoding (right-shift)</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">scaleShift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">l_sf</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 64-bit? then /8 (&gt;&gt;3); else /4 (&gt;&gt;2)</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l_imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">imm</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">scaleShift</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFF</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// set 12 bit immediate value</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">l_imm</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">l_ins</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">ADD instruction (immediate)</span><a class="headerlink" href="#id7" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">* @brief Generates an ADD (immediate) instruction.</span>
<span class="cm">*</span>
<span class="cm">* @param reg_dest destination register.</span>
<span class="cm">* @param reg_src1 source register.</span>
<span class="cm">* @param imm12 12-bit immediate value.</span>
<span class="cm">* @param shift shift value.</span>
<span class="cm">*</span>
<span class="cm">* @return instruction.</span>
<span class="cm">*/</span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="w"> </span><span class="n">reg_dest</span><span class="p">,</span>
<span class="w">                       </span><span class="n">gpr_t</span><span class="w"> </span><span class="n">reg_src</span><span class="p">,</span>
<span class="w">                       </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">imm12</span><span class="p">,</span>
<span class="w">                       </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l_ins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x11000000</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// set size</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l_sf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg_dest</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">;</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">l_sf</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span><span class="w"> </span><span class="c1">// set bit 31</span>

<span class="w">    </span><span class="c1">// set destination register id</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l_reg_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg_dest</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">;</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">l_reg_id</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// set first source register id</span>
<span class="w">    </span><span class="n">l_reg_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg_src</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">;</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">l_reg_id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// set immediate value</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l_imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imm12</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xfff</span><span class="p">;</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">l_imm</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// set shift value</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l_shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">;</span>
<span class="w">    </span><span class="n">l_ins</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">l_shift</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">l_ins</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>For more information on the instructions, please refer to <a class="reference internal" href="../api/namespaces/mini_jit_instructions.html#api-mini-jit-instructions"><span class="std std-ref">API: mini_jit:instructions</span></a>.</p>
</section>
<section id="microkernel-generation">
<h4>4.1.1.2 Microkernel Generation<a class="headerlink" href="#microkernel-generation" title="Link to this heading"></a></h4>
<p>Having implemented all necessary C++ functions for generating the assembly instructions, we then turned our attention to the microkernel generation. Here, the first kernel we approached was the <code class="docutils literal notranslate"><span class="pre">matmul_16_6_1</span></code> kernel. The process was to copy the assembly code line by line and replace all instructions with our C++ bindings. A part of the result can be seen in the following code snippet:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">Loading of inputs section of the matmul_16_6_1 kernel using C++ JIT code generation</span><a class="headerlink" href="#id8" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load Matrix A</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="c1">// Load Matrix C</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v16</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v18</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v20</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v21</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v23</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v24</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v25</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v26</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v27</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">FMLA section of the matmul_16_6_1 kernel using C++ JIT code generation</span><a class="headerlink" href="#id9" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load Column of Matrix B</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v28</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="c1">// 1st Multiplication</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v28</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v28</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v28</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v28</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="c1">// Load Column of Matrix B</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="c1">// 2nd Multiplication</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="c1">// Load Column of Matrix B</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="c1">// 3rd Multiplication</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All instructions are added to a <code class="docutils literal notranslate"><span class="pre">kernel</span></code> object. This code structure was already given to us, so we will not explain it in detail here. Basically, the <code class="docutils literal notranslate"><span class="pre">kernel</span></code> object is responsible for holding all instructions in a buffer, allocating the necessary memory, writing the instructions to the memory and then making the allocated memory executable. The <code class="docutils literal notranslate"><span class="pre">kernel</span></code> object is also able to later release the allocated memory again.</p>
</div>
<p>Towards the goal of implementing a <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> kernel, we now had to start supporting arbitrary dimension sizes. We decided to start implementing a loop over the <code class="docutils literal notranslate"><span class="pre">k</span></code> dimension, thus extending the <code class="docutils literal notranslate"><span class="pre">matmul_16_6_1</span></code> kernel to <code class="docutils literal notranslate"><span class="pre">matmul_16_6_k</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">K-Loop section of the matmul_16_6_k kernel using C++ JIT code generation</span><a class="headerlink" href="#id10" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Setup for Loop</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// K loop counter</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Matrix A pointer</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Matrix B pointer</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Row index for Matrix B</span>

<span class="p">[</span><span class="n">matmul_16_6_1</span><span class="w"> </span><span class="n">kernel</span><span class="p">]</span>

<span class="c1">// Decrement K</span>
<span class="c1">// move to next column of A</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="c1">// move to next row of B</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="c1">// edit K and jump to start of the kernel</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">sub</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">cbnz</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">-168</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</pre></div>
</div>
</div>
</section>
<section id="microkernel-benchmark">
<h4>4.1.1.3 Microkernel Benchmark<a class="headerlink" href="#microkernel-benchmark" title="Link to this heading"></a></h4>
<p>The last step of the task was to run benchmarks. We obtained the following results:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Benchmarking Matmul_16_6_1 throughput ...
-----------------------------------------------
Measuring throughput for Instruction
Total time (s):   1.19943
Instructions per Second:   2.40114e+10
Estimated GFLOPS:   24.0114 GFLOPS/sec
-----------------------------------------------

Benchmarking Matmul_16_6_64 throughput ...
-----------------------------------------------
Measuring throughput for Instruction
Total time (s):   1.82951
Instructions per Second:   1.34331e+11
Estimated GFLOPS:   134.331 GFLOPS/sec
-----------------------------------------------
</pre></div>
</div>
</section>
</section>
<section id="gemm">
<span id="id2"></span><h3>4.1.2 GEMM<a class="headerlink" href="#gemm" title="Link to this heading"></a></h3>
<p>After setting the foundation for the execution of a specific <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> kernel, our plan was now to extend the in <a class="reference internal" href="#brgemm-microkernel"><span class="std std-ref">4.1.1 Microkernel</span></a> implemented kernel to a more general <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> kernel.</p>
<section id="implementation-of-a-gemm-kernel">
<h4>4.1.2.1 Implementation of a GEMM kernel<a class="headerlink" href="#implementation-of-a-gemm-kernel" title="Link to this heading"></a></h4>
<p>The general <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> kernel should be able to compute C+=AB for arbitrary A, B and C matrices in the range of 1≤M≤1024, 1≤N≤1024, and 1≤K≤2048.</p>
<p>At first, we had to decide on how to block the matrices. In the M dimension, we decided to use a block size of 16 and in the <code class="docutils literal notranslate"><span class="pre">n</span></code> dimension we decided to use a block size of 4. The larger we keep the block size, the more efficiently we can use loads, stores and FMLA instructions. However, the issue with large block sizes is that we need to write a lot of specialized kernels for all M and N dimensions smaller or equal to the block size. If the input parameters are not multiples of the block size, we need to write additional code to handle the remaining elements.</p>
<p>For a block size of M = 8 we already wrote a kernel in neon assembly, see <a class="reference internal" href="03_neon.html#generic-kernel"><span class="std std-ref">3.4.3 Generic Approach</span></a>. Using this generic kernel as a starting point, we have reduced the <code class="docutils literal notranslate"><span class="pre">n</span></code> dimension from 6 to 4. Our reasoning was that we wanted to reduce the number of specialized kernels we would need to write. Additionally, we assumed that in practice more numbers would be multiples of 4 instead of 6, thus not depending on such specialized kernels. Nevertheless, we made the decision to increase M from 8 to 16 to increase our overall performance. With this change, we introduced the <code class="docutils literal notranslate"><span class="pre">matmul_m_4_k</span></code> kernel, which computes C+=AB for matrices where M and K are freely configurable, and N is fixed at size 4.</p>
<p>The kernel first computes the number of blocks along the M dimension, as well as any remaining elements.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">matmul_m_4_k: Computing the number of blocks in the M dimension</span><a class="headerlink" href="#id11" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">mLoopIterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">mLoopRemainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Using these numbers, we can call the specialized kernels:</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">matmul_m_4_k: Calling specialized kernels for different M dimensions</span><a class="headerlink" href="#id12" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mLoopIterations</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM16N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">mLoopIterations</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mLoopRemainder</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// set up k loop counter</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// save base matrix pointers</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">));</span><span class="w"> </span><span class="c1">// A</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">));</span><span class="w"> </span><span class="c1">// B</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w">         </span><span class="c1">// row count B</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mLoopRemainder</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM1N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM2N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM3N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM4N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM5N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM6N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM7N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM8N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">9</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM9N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM10N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">11</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM11N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM12N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM13N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM14N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">subkernels</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateM15N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>But what does such a specialized kernel look like? For the most part, they are similar to the microkernels we implemented before. The only difference is that we need to adjust the loads, stores and FMLA instructions for a fixed M dimension. For example in the case of M = 3:</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">matmul_m_4_k: Loading a column of C with M = 3</span><a class="headerlink" href="#id13" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// first column</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x12</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldrPost</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>While we can simply load a double word when M = 2 or even a quad word when M = 4, we need to divide our loads into two parts when M = 3. First, we load a double word and then the remaining single word. The same applies to the stores:</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">matmul_m_4_k: Storing a column of C with M = 3</span><a class="headerlink" href="#id14" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// first column</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x12</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">strPost</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>The FMLA instructions are also adjusted based on M dimension. For example, when M = 3, we need to use two FMLA instructions to compute the result:</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">matmul_m_4_k: FMLA instructions with M = 3</span><a class="headerlink" href="#id15" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// B: COLUMN 0</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmlaElem</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v24</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s2</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmadd</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v25</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>While one could use an <code class="docutils literal notranslate"><span class="pre">fmla</span></code> instruction and zero padding, we decided to use one <code class="docutils literal notranslate"><span class="pre">fmla</span></code> instruction for the first two elements and one <code class="docutils literal notranslate"><span class="pre">fmadd</span></code> instruction for the last element. We did not observe any performance differences between the two approaches, but chose the second one because to us it seemed more readable and easier to understand. The other specialized kernels for M = 1, 2, 4, 5, 6 and 7 are implemented similarly.</p>
<p>Having implemented the <code class="docutils literal notranslate"><span class="pre">matmul_m_4_k</span></code> kernel, we can now turn our attention towards the <code class="docutils literal notranslate"><span class="pre">matmul_m_n_k</span></code> kernel. Since we decided to block N by 4, we can use the same approach as before. We first compute the number of blocks along the <code class="docutils literal notranslate"><span class="pre">n</span></code> dimension and the remaining elements.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">matmul_m_n_k: Computing the number of blocks in the N dimension</span><a class="headerlink" href="#id16" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">nLoopIterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">nLoopRemainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">nLoopRemainder</span></code> can take any value between 0 and 3, which means that additionally to the <code class="docutils literal notranslate"><span class="pre">matmul_m_4_k</span></code> kernel where <code class="docutils literal notranslate"><span class="pre">nLoopRemainder</span></code> is 0, we need to implement specialized kernels for <code class="docutils literal notranslate"><span class="pre">nLoopRemainder</span></code> = 1, 2 and 3. The specialized kernels are basically the same as the <code class="docutils literal notranslate"><span class="pre">matmul_m_4_k</span></code> kernel, but we simply removed some of the loads, stores and FMLA instructions. For the more curious reader, we recommend viewing <a class="reference internal" href="../api/namespaces/mini_jit_kernels.html#api-mini-jit-kernels"><span class="std std-ref">API: mini_jit:kernels</span></a>.</p>
<p>For the whole N loop, we use switch statements to call the specialized kernels. The final implementation looks like this:</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">matmul_m_n_k: Calling kernels for different N</span><a class="headerlink" href="#id17" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nLoopIterations</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// n_loop:</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&quot;n_loop&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Save base matrix pointers</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x0</span><span class="p">));</span><span class="w">   </span><span class="c1">// A</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x20</span><span class="p">));</span><span class="w">  </span><span class="c1">// B</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x21</span><span class="p">));</span><span class="w"> </span><span class="c1">// C</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mLoopIterations</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM16N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">mLoopIterations</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mLoopRemainder</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// set up k loop counter</span>
<span class="w">        </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// save base matrix pointers</span>
<span class="w">        </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">));</span><span class="w"> </span><span class="c1">// A</span>
<span class="w">        </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">));</span><span class="w"> </span><span class="c1">// B</span>
<span class="w">        </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w">         </span><span class="c1">// row count B</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mLoopRemainder</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM1N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM2N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM3N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM4N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM5N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM6N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM7N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM8N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">9</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM9N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM10N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">11</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM11N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM12N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM13N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM14N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span>
<span class="w">            </span><span class="n">internal_subkernels</span><span class="o">::</span><span class="n">generateM15N4Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// increase B and C pointers for next block</span>
<span class="w">    </span><span class="c1">// (jump 4 columns) 4*x4, 4*x5</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// decrement n loop counter</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">sub</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">l_nLoopInstrCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel</span><span class="p">.</span><span class="n">getInstrCountFromLabel</span><span class="p">(</span><span class="s">&quot;n_loop&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">cbnz</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">l_nLoopInstrCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// END N LOOP</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nLoopRemainder</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Save base matrix pointers</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x0</span><span class="p">));</span><span class="w">   </span><span class="c1">// A</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x20</span><span class="p">));</span><span class="w">  </span><span class="c1">// B</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x21</span><span class="p">));</span><span class="w"> </span><span class="c1">// C</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">nLoopRemainder</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateN1Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">mLoopIterations</span><span class="p">,</span><span class="w"> </span><span class="n">mLoopRemainder</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateN2Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">mLoopIterations</span><span class="p">,</span><span class="w"> </span><span class="n">mLoopRemainder</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">        </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">generateN3Loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">mLoopIterations</span><span class="p">,</span><span class="w"> </span><span class="n">mLoopRemainder</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As seen in the code snippet above, we extended our kernel object by an <code class="docutils literal notranslate"><span class="pre">add_label</span></code> function and a <code class="docutils literal notranslate"><span class="pre">getInstrCountFromLabel</span></code> function. Internally, the kernel keeps track of the number of instructions that were added since the label was added. If we want to jump back to a label, we can use <code class="docutils literal notranslate"><span class="pre">getInstrCountFromLabel</span></code> to get the number of instructions we have to jump and multiply it by 4, because each instruction is 4 bytes long.</p>
</div>
<p>The full code is available in the file <a class="reference external" href="https://github.com/Shad00Z/machine-learning-compilers/blob/main/src/kernels/matmul/matmul_m_n_k.cpp">matmul_m_n_k.cpp</a>.</p>
</section>
<section id="calling-the-gemm-kernel">
<h4>4.1.2.2 Calling the GEMM kernel<a class="headerlink" href="#calling-the-gemm-kernel" title="Link to this heading"></a></h4>
<p>Having implemented the code for the <code class="docutils literal notranslate"><span class="pre">matmul_m_n_k</span></code>, we now had to find a way to call it. For this, we use a <code class="docutils literal notranslate"><span class="pre">Brgemm</span></code> class that contains a <code class="docutils literal notranslate"><span class="pre">generate</span></code> function. We use the same function to call our <code class="docutils literal notranslate"><span class="pre">matmul_br_m_n_k</span></code> BRGEMM kernel, which is explained in the next chapter. For more details on the <code class="docutils literal notranslate"><span class="pre">Brgemm</span></code> class, please refer to <a class="reference internal" href="#id3"><span class="std std-ref">4.1.3.2 Calling the Batch-Reduce GEMM kernel</span></a>.</p>
</section>
<section id="verification-of-the-gemm-kernel-with-lda-m-ldb-k-ldc-m">
<h4>4.1.2.3 Verification of the GEMM kernel with lda=M, ldb=K, ldc=M<a class="headerlink" href="#verification-of-the-gemm-kernel-with-lda-m-ldb-k-ldc-m" title="Link to this heading"></a></h4>
<p>This task requires us to verify the correctness of our <code class="docutils literal notranslate"><span class="pre">matmul_m_n_k</span></code> kernel by comparing it to a reference implementation for 1≤M≤64, 1≤N≤64, K∈[1,16,32,64,128], with lda=M, ldb=K, and ldc=M.
We realized this verification using a <code class="docutils literal notranslate"><span class="pre">Catch2</span></code> unit test:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_CASE</span><span class="p">(</span><span class="s">&quot;Reference test for matmul kernel with variable M, N, K&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[matmul][parameterized]&quot;</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">);</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C_expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">];</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">random_device</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mt19937</span><span class="w"> </span><span class="nf">gen</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">uniform_real_distribution</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="mf">-0.5f</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C_expected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Reference GEMM calculation</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">col</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">row</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">C_expected</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Kernel</span><span class="w"> </span><span class="n">l_kernel</span><span class="p">;</span>
<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">matmul_m_n_k</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">);</span>
<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="w"> </span><span class="n">l_kernel_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">()));</span>
<span class="w">    </span><span class="n">l_kernel_t</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">REQUIRE</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Approx</span><span class="p">(</span><span class="n">C_expected</span><span class="p">[</span><span class="n">i</span><span class="p">]).</span><span class="n">margin</span><span class="p">(</span><span class="n">FLOAT_ERROR_MARGIN</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">A</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">B</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">C</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">C_expected</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The M and N dimensions are generated randomly, while the <code class="docutils literal notranslate"><span class="pre">k</span></code> dimension is fixed to multiple given values. We compute the expected result using high level C++ code and compare it to the result of our kernel.</p>
</section>
<section id="verification-of-the-gemm-kernel-with-lda-m-ldb-k-or-ldc-m">
<h4>4.1.2.4 Verification of the GEMM kernel with lda&gt;M, ldb&gt;K or ldc&gt;M<a class="headerlink" href="#verification-of-the-gemm-kernel-with-lda-m-ldb-k-or-ldc-m" title="Link to this heading"></a></h4>
<p>This task is very similar to the previous one, but we need to verify the correctness of our <code class="docutils literal notranslate"><span class="pre">matmul_m_n_k</span></code> kernel for 1≤M≤64, 1≤N≤64, K∈[1,16,32,64,128], and lda&gt;M, ldb&gt;K or ldc&gt;M. This means that we need to store the matrices in a way that they are not contiguous in memory. We can do this by first choosing strides that are larger than the M, N and K dimensions. The next step is to use these strides to compute the addresses of the elements in the matrices. We can then use the strides to allocate memory larger larger than the matrices and set the elements used in the computation. The other elements, which will be skipped due to the strides, will be set to 0. Lastly, we call our kernel and compare the result to the expected result:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_CASE</span><span class="p">(</span><span class="s">&quot;Reference test for matmul kernel with variable M, N, K and lda&gt;M, ldb&gt;K or ldc&gt;M&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[matmul][parameterized][larger strides]&quot;</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">);</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">random_device</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mt19937</span><span class="w"> </span><span class="nf">gen</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">uniform_int_distribution</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strideDist</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Set strides larger than dimensions</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">lda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">strideDist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ldb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">strideDist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ldc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">strideDist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Allocate space for matrices larger than M, N, K</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">lda</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">ldb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">ldc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C_expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">ldc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">];</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">uniform_real_distribution</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="mf">-0.5f</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Initialize A</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lda</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">m</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">A</span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Initialize B</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ldb</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ldb</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Initialize C and C_expected</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ldc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">m</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">            </span><span class="n">C</span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ldc</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">            </span><span class="n">C_expected</span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ldc</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Reference GEMM calculation</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">col</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">row</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lda</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ldb</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">C_expected</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ldc</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Kernel</span><span class="w"> </span><span class="n">l_kernel</span><span class="p">;</span>
<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">matmul_m_n_k</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">);</span>
<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="w"> </span><span class="n">l_kernel_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">()));</span>
<span class="w">    </span><span class="n">l_kernel_t</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">lda</span><span class="p">,</span><span class="w"> </span><span class="n">ldb</span><span class="p">,</span><span class="w"> </span><span class="n">ldc</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">m</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">REQUIRE</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ldc</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Approx</span><span class="p">(</span><span class="n">C_expected</span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ldc</span><span class="p">]).</span><span class="n">margin</span><span class="p">(</span><span class="n">FLOAT_ERROR_MARGIN</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">A</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">B</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">C</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">C_expected</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="benchmarking-the-gemm-kernel">
<span id="gemm-bench"></span><h4>4.1.2.5 Benchmarking the GEMM kernel<a class="headerlink" href="#benchmarking-the-gemm-kernel" title="Link to this heading"></a></h4>
<p>For the benchmarking we enhanced our <code class="docutils literal notranslate"><span class="pre">benchmarking.cpp</span></code> file that was used for the previous tasks.
Our task was to benchmark the performance of our generated kernels and report the measured
performance for 1≤M≤64, 1≤N≤64, K∈[1,16,32,64,128], lda=M, ldb=K and ldc=M.</p>
<p>We were also given a baseline CSV file, which gave us a structure, on how to safe our benchmarking performance.
Our idea was run each of these benchmarks for a time of <code class="docutils literal notranslate"><span class="pre">1.5s</span></code> in order to guarantee comparable results.
During this time we calculated the number of iterations our <code class="docutils literal notranslate"><span class="pre">matmul_m_n_k</span></code> kernel would perform.
Using this metrics we could then calculate the performance in GFLOPs for the respective execution.</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">matmul_m_n_k benchmarking approach for different M, N, and K</span><a class="headerlink" href="#id18" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generate and get the kernel function</span>
<span class="n">mini_jit</span><span class="o">::</span><span class="n">Kernel</span><span class="w"> </span><span class="n">l_kernel</span><span class="p">;</span>
<span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">matmul_m_n_k</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">m_M</span><span class="p">,</span><span class="w"> </span><span class="n">m_N</span><span class="p">,</span><span class="w"> </span><span class="n">m_K</span><span class="p">);</span>
<span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="w"> </span><span class="n">l_kernel_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">()));</span>

<span class="c1">// RUN</span>
<span class="kt">long</span><span class="w"> </span><span class="n">l_num_reps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">l_start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="kt">double</span><span class="w"> </span><span class="n">l_elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">l_runTimeMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_run_time</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span>
<span class="k">do</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">l_kernel_t</span><span class="p">(</span><span class="n">m_A</span><span class="p">,</span><span class="w"> </span><span class="n">m_B</span><span class="p">,</span><span class="w"> </span><span class="n">m_C</span><span class="p">,</span><span class="w"> </span><span class="n">m_M</span><span class="p">,</span><span class="w"> </span><span class="n">m_K</span><span class="p">,</span><span class="w"> </span><span class="n">m_M</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="o">++</span><span class="n">l_num_reps</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">l_now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">l_elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">l_now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_start_time</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">l_elapsed</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l_runTimeMs</span><span class="p">);</span>
<span class="n">l_elapsed</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span><span class="w"> </span><span class="c1">// Convert to seconds</span>
<span class="c1">// END RUN</span>

<span class="c1">// Calculate metrics</span>
<span class="kt">long</span><span class="w"> </span><span class="n">l_totalOperations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_num_reps</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">l_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">l_totalOperations</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">l_elapsed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e9</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>The results that we obtained were saved under <a class="reference external" href="https://github.com/Shad00Z/machine-learning-compilers/blob/main/benchmarks/gemm_perf.csv">benchmarks/gemm_perf.csv</a>.</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">Snippet of executed benchmarks for matmul_m_n_k</span><a class="headerlink" href="#id19" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>m,n,k,br_size,trans_a,trans_b,trans_c,ld_a,ld_b,ld_c,br_stride_a,br_stride_b,num_reps,time,gflops
1,1,1,1,0,0,0,0,0,0,0,0,54127879,1.5,0.0721705
1,1,16,1,0,0,0,0,0,0,0,0,44228413,1.5,0.943539
1,1,32,1,0,0,0,0,0,0,0,0,30326543,1.5,1.29393
1,1,64,1,0,0,0,0,0,0,0,0,19160608,1.5,1.63504
1,1,128,1,0,0,0,0,0,0,0,0,10973115,1.5,1.87274
1,2,1,1,0,0,0,0,0,0,0,0,55889405,1.5,0.149038
1,2,16,1,0,0,0,0,0,0,0,0,43394974,1.5,1.85152
1,2,32,1,0,0,0,0,0,0,0,0,30144269,1.5,2.57231
1,2,64,1,0,0,0,0,0,0,0,0,18992617,1.5,3.24141
1,2,128,1,0,0,0,0,0,0,0,0,10804485,1.5,3.68793
1,3,1,1,0,0,0,0,0,0,0,0,55753919,1.5,0.223016
1,3,16,1,0,0,0,0,0,0,0,0,43017743,1.5,2.75314
1,3,32,1,0,0,0,0,0,0,0,0,30005166,1.5,3.84066
1,3,64,1,0,0,0,0,0,0,0,0,18859806,1.5,4.82811
</pre></div>
</div>
</div>
</section>
</section>
<section id="batch-reduce-gemm">
<h3>4.1.3 Batch-Reduce GEMM<a class="headerlink" href="#batch-reduce-gemm" title="Link to this heading"></a></h3>
<p>After generating our GEMM kernel for different values of the M, N, and K dimensions, we implemented a batched version of this kernel.
This means we now had to implement kernels that support matrix multiplications of the form: C+=∑AᵢBᵢ.</p>
<section id="support-for-batch-reduce-gemms">
<h4>4.1.3.1 Support for Batch-Reduce GEMMs<a class="headerlink" href="#support-for-batch-reduce-gemms" title="Link to this heading"></a></h4>
<p>We based our <code class="docutils literal notranslate"><span class="pre">matmul_br_m_n_k</span></code> implementation on our assembly version of the <a class="reference internal" href="03_neon.html#batch-reduce-gemm"><span class="std std-ref">batch-reduce GEMM</span></a>.
As we now had the additional values <code class="docutils literal notranslate"><span class="pre">br_stride_a</span></code> and <code class="docutils literal notranslate"><span class="pre">br_stride_a</span></code> we needed to slightly adjust the use of our registers.
Apart from that, we were ready to start.</p>
<p>The first step we took was to initialize the loop counter for the batch dimension.</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">matmul_br_m_n_k: br counter initialization</span><a class="headerlink" href="#id20" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// batch counter</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="n">br_size</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&quot;batch_loop&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>The second step was to make sure that after a GEMM has finished, we would increment the pointers, to move to the next respective matrices.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// handle batching</span>
<span class="c1">// move to next A matrix</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x0</span><span class="p">));</span>
<span class="c1">// move to next B matrix</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x1</span><span class="p">));</span>
<span class="c1">// restore pointer to C matrix</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x21</span><span class="p">));</span>

<span class="c1">// decrement batch loop counter</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">sub</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="c1">// check if loop counter is zero</span>
<span class="kt">int</span><span class="w"> </span><span class="n">l_batchLoopInstrCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel</span><span class="p">.</span><span class="n">getInstrCountFromLabel</span><span class="p">(</span><span class="s">&quot;batch_loop&quot;</span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">cbnz</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">l_batchLoopInstrCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
<p>These were the only changes we had to make. Between initializing the loop and jumping to the next blocks in our matrices, we would loop over our <a class="reference internal" href="#gemm"><span class="std std-ref">matmul_m_n_k kernel</span></a>.</p>
</section>
<section id="calling-the-batch-reduce-gemm-kernel">
<span id="id3"></span><h4>4.1.3.2 Calling the Batch-Reduce GEMM kernel<a class="headerlink" href="#calling-the-batch-reduce-gemm-kernel" title="Link to this heading"></a></h4>
<p>In order to actually call our <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> and <code class="docutils literal notranslate"><span class="pre">BRGEMM</span></code> kernels, we had to implement a common entry point. The <code class="docutils literal notranslate"><span class="pre">Brgemm</span></code> class is responsible for this task.
It first checks all input parameters for their validity and then makes calls to the kernels based on the batch-reduce size.</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">Brgemm.cpp</span><a class="headerlink" href="#id21" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">mini_jit</span><span class="o">::</span><span class="n">error_t</span><span class="w"> </span><span class="nf">mini_jit::Brgemm::generate</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">m</span><span class="p">,</span>
<span class="w">                                            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">n</span><span class="p">,</span>
<span class="w">                                            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">k</span><span class="p">,</span>
<span class="w">                                            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">br_size</span><span class="p">,</span>
<span class="w">                                            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">trans_a</span><span class="p">,</span>
<span class="w">                                            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">trans_b</span><span class="p">,</span>
<span class="w">                                            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">trans_c</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">dtype_t</span><span class="w"> </span><span class="n">dtype</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Currently supported:</span>
<span class="cm">    * trans_a, trans_b, trans_c: Column-major</span>
<span class="cm">    * dtype: fp32</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;M must be greater than 0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;M must not be greater than 2048&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;N must be greater than 0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;N must not be greater than 2048&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;K must be greater than 0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;K must not be greater than 2048&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">br_size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;BR_SIZE must greater than 0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">br_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;BR_SIZE must not be greater than 2048&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trans_a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">trans_b</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">trans_c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Matrix ordering must be column-major&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_matrix_ordering_format</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dtype</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dtype_t</span><span class="o">::</span><span class="n">fp32</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Matrix data type must be fp32&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dtype</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">reset_kernel</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">br_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">matmul_m_n_k</span><span class="p">(</span><span class="o">*</span><span class="n">m_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">matmul_br_m_n_k</span><span class="p">(</span><span class="o">*</span><span class="n">m_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">br_size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Valid matrix kernel</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">success</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="w"> </span><span class="nf">mini_jit::Brgemm::get_kernel</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">kernel_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">m_kernel</span><span class="o">-&gt;</span><span class="n">get_kernel</span><span class="p">()));</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">mini_jit::Brgemm::reset_kernel</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_kernel</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_kernel</span><span class="p">;</span>
<span class="w">        </span><span class="n">m_kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">m_kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Kernel</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>The example below demonstrates how this function can be called:</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">Example code for generating and executing a kernel</span><a class="headerlink" href="#id22" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Kernel</span><span class="w"> </span><span class="n">l_kernel</span><span class="p">;</span>
<span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">matmul_m_n_k</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">);</span>
<span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="w"> </span><span class="n">l_kernel_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">()));</span>
<span class="n">l_kernel_t</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
</div>
</section>
<section id="verification-of-the-batch-reduce-gemm-kernel">
<h4>4.1.3.3 Verification of the Batch-Reduce GEMM kernel<a class="headerlink" href="#verification-of-the-batch-reduce-gemm-kernel" title="Link to this heading"></a></h4>
<p>Similar to the <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> kernel, we also tested our implementation of the batch-reduce GEMM.
We executed several initializations of our kernel, using a similar approach to the testing of the <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> kernel:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_CASE</span><span class="p">(</span><span class="s">&quot;Reference test for batch reduce matmul kernel with variable M, N, K&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[br_matmul][parameterized]&quot;</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GENERATE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">br_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">br_size</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">br_size</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C_expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">];</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">random_device</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mt19937</span><span class="w"> </span><span class="nf">gen</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">uniform_real_distribution</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="mf">-0.5f</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">br_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">br_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C_expected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Reference batched GEMM calculation</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">col</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">row</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">br_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">br</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">br</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">br</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">C_expected</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Kernel</span><span class="w"> </span><span class="n">l_kernel</span><span class="p">;</span>
<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">matmul_br_m_n_k</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">br_size</span><span class="p">);</span>
<span class="w">    </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="w"> </span><span class="n">l_kernel_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">()));</span>
<span class="w">    </span><span class="n">l_kernel_t</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">REQUIRE</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Approx</span><span class="p">(</span><span class="n">C_expected</span><span class="p">[</span><span class="n">i</span><span class="p">]).</span><span class="n">margin</span><span class="p">(</span><span class="n">FLOAT_ERROR_MARGIN</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">A</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">B</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">C</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">C_expected</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="benchmarking-the-batch-reduce-gemm-kernel">
<span id="brgemm-bench"></span><h4>4.1.3.4 Benchmarking the Batch-Reduce GEMM kernel<a class="headerlink" href="#benchmarking-the-batch-reduce-gemm-kernel" title="Link to this heading"></a></h4>
<p>For the benchmarks, we enhanced our <code class="docutils literal notranslate"><span class="pre">benchmarking.cpp</span></code> file again.
We introduced a new function that should handle 1≤M≤64, 1≤N≤64, K∈[1,16,32,64,128], lda=M, ldb=K and ldc=M and reduced the time for our benchmarks to <code class="docutils literal notranslate"><span class="pre">1.0s</span></code>. The calculation for the GFLOPs is almost the same as for the <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> kernel, however now we also need to multiply the number of operations by the Batch-Reduce dimension size <code class="docutils literal notranslate"><span class="pre">br_size</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generate and get the kernel function</span>
<span class="n">mini_jit</span><span class="o">::</span><span class="n">Kernel</span><span class="w"> </span><span class="n">l_kernel</span><span class="p">;</span>
<span class="n">mini_jit</span><span class="o">::</span><span class="n">kernels</span><span class="o">::</span><span class="n">matmul</span><span class="o">::</span><span class="n">matmul_br_m_n_k</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">m_M</span><span class="p">,</span><span class="w"> </span><span class="n">m_N</span><span class="p">,</span><span class="w"> </span><span class="n">m_K</span><span class="p">,</span><span class="w"> </span><span class="n">m_br_size</span><span class="p">);</span>
<span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="w"> </span><span class="n">l_kernel_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">Brgemm</span><span class="o">::</span><span class="n">kernel_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">()));</span>

<span class="c1">// RUN</span>
<span class="kt">long</span><span class="w"> </span><span class="n">l_num_reps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">l_start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="kt">double</span><span class="w"> </span><span class="n">l_elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">l_runTimeMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_run_time</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span>
<span class="k">do</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">l_kernel_t</span><span class="p">(</span><span class="n">m_A</span><span class="p">,</span><span class="w"> </span><span class="n">m_B</span><span class="p">,</span><span class="w"> </span><span class="n">m_C</span><span class="p">,</span><span class="w"> </span><span class="n">m_M</span><span class="p">,</span><span class="w"> </span><span class="n">m_K</span><span class="p">,</span><span class="w"> </span><span class="n">m_M</span><span class="p">,</span><span class="w"> </span><span class="n">m_M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_K</span><span class="p">,</span><span class="w"> </span><span class="n">m_K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_N</span><span class="p">);</span>
<span class="w">    </span><span class="o">++</span><span class="n">l_num_reps</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">l_now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">    </span><span class="n">l_elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">l_now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_start_time</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">l_elapsed</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l_runTimeMs</span><span class="p">);</span>
<span class="n">l_elapsed</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span><span class="w"> </span><span class="c1">// Convert to seconds</span>
<span class="c1">// END RUN</span>

<span class="c1">// Calculate metrics</span>
<span class="kt">long</span><span class="w"> </span><span class="n">l_totalOperations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_num_reps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_br_size</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">l_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">l_totalOperations</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">l_elapsed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e9</span><span class="p">);</span>
</pre></div>
</div>
<p>The results that we obtained were saved in <a class="reference external" href="https://github.com/Shad00Z/machine-learning-compilers/blob/main/benchmarks/brgemm_perf.csv">br_gemm_perf.csv</a>.</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">Snippet of executed benchmarks for matmul_br_m_n_k</span><a class="headerlink" href="#id23" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>m,n,k,br_size,trans_a,trans_b,trans_c,ld_a,ld_b,ld_c,br_stride_a,br_stride_b,num_reps,time,gflops
1,1,1,16,0,0,0,1,1,1,1,1,14713094,1,0.470819
1,1,16,16,0,0,0,1,16,1,16,16,3412968,1,1.74744
1,1,32,16,0,0,0,1,32,1,32,32,1845891,1,1.89019
1,1,64,16,0,0,0,1,64,1,64,64,1007179,1,2.0627
1,1,128,16,0,0,0,1,128,1,128,128,516692,1,2.11637
1,2,1,16,0,0,0,1,1,1,1,2,15004415,1,0.960283
1,2,16,16,0,0,0,1,16,1,16,32,3483409,1,3.56701
1,2,32,16,0,0,0,1,32,1,32,64,1914029,1,3.91993
1,2,64,16,0,0,0,1,64,1,64,128,1005414,1,4.11817
1,2,128,16,0,0,0,1,128,1,128,256,515745,1,4.22498
1,3,1,16,0,0,0,1,1,1,1,3,14941217,1,1.43436
1,3,16,16,0,0,0,1,16,1,16,48,3458013,1,5.31151
1,3,32,16,0,0,0,1,32,1,32,96,1911851,1,5.87321
1,3,64,16,0,0,0,1,64,1,64,192,1004800,1,6.17349
</pre></div>
</div>
</div>
<p>Evaluating our GFLOP performance, we can see that we achieve a similar performance as in our <code class="docutils literal notranslate"><span class="pre">matmul_m_n_k</span></code> benchmark.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Both the <a class="reference internal" href="#gemm-bench"><span class="std std-ref">gemm</span></a> and <a class="reference internal" href="#brgemm-bench"><span class="std std-ref">brgemm</span></a> benchmarks were executed using our initial kernel configurations of M=8 and N=4.
Therefore, the results should be viewed carefully, as the new configuration M=16 and N=4 should drastically enhance the throughput, especially for large matrices.</p>
</div>
</section>
</section>
</section>
<section id="unary-primitives">
<span id="id4"></span><h2>4.2 Unary Primitives<a class="headerlink" href="#unary-primitives" title="Link to this heading"></a></h2>
<p>After implementing our main primitives using the <code class="docutils literal notranslate"><span class="pre">GEMM</span></code> and <code class="docutils literal notranslate"><span class="pre">BRGEMM</span></code> kernels, the next step was to implement unary primitives.
These can be called before an operation is executed (first touch) or after the final block of a matrix has been processed (last touch).
Specifically we are implementing three of those primitives:</p>
<ol class="arabic simple">
<li><p>Zero Primitive</p></li>
<li><p>Identity Primitive</p></li>
<li><p>ReLU Primitive</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For this submission, we overhauled our benchmarking framework once again.
After compilation, the main entry point can be called using <code class="docutils literal notranslate"><span class="pre">./build/&lt;OS_NAME&gt;/benchmarks</span></code>, but this alone will not execute any benchmarks.
The benchmark types to run are specified using command-line arguments, such as <code class="docutils literal notranslate"><span class="pre">matmul</span></code> or <code class="docutils literal notranslate"><span class="pre">unary</span></code>.
Multiple benchmarks can be run at once, for example by running: <code class="docutils literal notranslate"><span class="pre">./build/OS_NAME/benchmarks</span> <span class="pre">matmul</span> <span class="pre">unary</span></code>.
The results are saved as text files in the <code class="docutils literal notranslate"><span class="pre">benchmarks</span></code> folder.</p>
</div>
<section id="zero-primitive">
<h3>4.2.1 Zero Primitive<a class="headerlink" href="#zero-primitive" title="Link to this heading"></a></h3>
<p>The first unary primitive we implemented was the zero primitive.
This kernel is supposed to set all elements of the output matrix to zero, while ignoring the input matrix.
For this reason, this primitive is exclusively executed as a first touch primitive.</p>
<section id="zero-primitive-implementation">
<h4>4.2.1.1 Zero Primitive Implementation<a class="headerlink" href="#zero-primitive-implementation" title="Link to this heading"></a></h4>
<p>The functionality of the zero primitive can be implemented in many different ways, but we started with using an ARM instruction which we had already implemented: <code class="docutils literal notranslate"><span class="pre">STR</span></code>. We refer to this version as the <code class="docutils literal notranslate"><span class="pre">XZR</span></code> approach, because it uses the <code class="docutils literal notranslate"><span class="pre">XZR</span></code> (and sometimes <code class="docutils literal notranslate"><span class="pre">WZR</span></code>) register to store zeroes in the output matrix. The limitation here is that the <code class="docutils literal notranslate"><span class="pre">XZR</span></code> is only 64 bits wide, which means we can only set 2 FP32 values to zero at once. To improve this, we implemented a second version that uses <code class="docutils literal notranslate"><span class="pre">Neon</span></code> instructions. We first created a zero register using the <code class="docutils literal notranslate"><span class="pre">EOR</span></code> instruction (eg. <code class="docutils literal notranslate"><span class="pre">eor</span> <span class="pre">v31.16b,</span> <span class="pre">v31.16b,</span> <span class="pre">v31.16b</span></code> sets <code class="docutils literal notranslate"><span class="pre">v31</span></code> to zero) and then use <code class="docutils literal notranslate"><span class="pre">STP</span></code> to zero 8 FP32 values at once. This version is called the <code class="docutils literal notranslate"><span class="pre">EOR</span></code> approach.</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">XZR Zero Primitive: main loop</span><a class="headerlink" href="#id24" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span><span class="p">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&quot;m_8_loop&quot;</span><span class="p">);</span>
<span class="c1">// store 8 zeros</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">strPost</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">xzr</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">strPost</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">xzr</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">strPost</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">xzr</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">xzr</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="c1">// jump by 8 rows</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="c1">// decrement m loop counter</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">sub</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="c1">// check if loop counter is zero</span>
<span class="kt">int</span><span class="w"> </span><span class="n">l_mLoopInstrCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel</span><span class="p">.</span><span class="n">getInstrCountFromLabel</span><span class="p">(</span><span class="s">&quot;m_8_loop&quot;</span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">cbnz</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">l_mLoopInstrCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">EOR Zero Primitive: main loop</span><a class="headerlink" href="#id25" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span><span class="p">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&quot;m_8_loop&quot;</span><span class="p">);</span>
<span class="c1">// store 8 zeros</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">stp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="c1">// jump by 8 rows</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="c1">// decrement m loop counter</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">sub</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="c1">// check if loop counter is zero</span>
<span class="kt">int</span><span class="w"> </span><span class="n">l_mLoopInstrCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel</span><span class="p">.</span><span class="n">getInstrCountFromLabel</span><span class="p">(</span><span class="s">&quot;m_8_loop&quot;</span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">cbnz</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">l_mLoopInstrCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>In this primitive, we handle one column at a time. For all matrices where the number of rows is not divisible by 8, we implemented edge cases that handle the remaining elements. This approach is the same as the one we used in the matrix multiplication kernels, with the only difference being that we do not need to handle the K dimension.</p>
</section>
<section id="zero-primitive-benchmarks">
<h4>4.2.1.1 Zero Primitive Benchmarks<a class="headerlink" href="#zero-primitive-benchmarks" title="Link to this heading"></a></h4>
<p>We benchmarked the performance of our zero primitive for the given parameters (M=N=50, M=N=64, M=N=512 and M=N=2048) and obtained the following results:</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for the zero primitives</span><a class="headerlink" href="#id26" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Running zero_eor_primitive 50x50 benchmark
Total time (s):                       3
Total reps:                           24095571
Total number of elements:             60238927500
Total amount of processed data (GiB): 448.815
Bandwidth (GiB/s)                     149.605
--------------------------------------------------
Running zero_eor_primitive 64x64 benchmark
Total time (s):                       3
Total reps:                           14348177
Total number of elements:             58770132992
Total amount of processed data (GiB): 437.872
Bandwidth (GiB/s)                     145.957
--------------------------------------------------
Running zero_eor_primitive 512x512 benchmark
Total time (s):                       3
Total reps:                           333722
Total number of elements:             87483219968
Total amount of processed data (GiB): 651.801
Bandwidth (GiB/s)                     217.267
--------------------------------------------------
Running zero_eor_primitive 2048x2048 benchmark
Total time (s):                       3.00013
Total reps:                           8570
Total number of elements:             35945185280
Total amount of processed data (GiB): 267.812
Bandwidth (GiB/s)                     89.2671
--------------------------------------------------
Running zero_xzr_primitive 50x50 benchmark
Total time (s):                       3
Total reps:                           18821607
Total number of elements:             47054017500
Total amount of processed data (GiB): 350.58
Bandwidth (GiB/s)                     116.86
--------------------------------------------------
Running zero_xzr_primitive 64x64 benchmark
Total time (s):                       3
Total reps:                           8987787
Total number of elements:             36813975552
Total amount of processed data (GiB): 274.285
Bandwidth (GiB/s)                     91.4285
--------------------------------------------------
Running zero_xzr_primitive 512x512 benchmark
Total time (s):                       3
Total reps:                           184240
Total number of elements:             48297410560
Total amount of processed data (GiB): 359.844
Bandwidth (GiB/s)                     119.948
--------------------------------------------------
Running zero_xzr_primitive 2048x2048 benchmark
Total time (s):                       3.0004
Total reps:                           8216
Total number of elements:             34460401664
Total amount of processed data (GiB): 256.75
Bandwidth (GiB/s)                     85.5719
--------------------------------------------------
</pre></div>
</div>
</div>
<p>In all cases, we can see that the <code class="docutils literal notranslate"><span class="pre">EOR</span></code> approach is significantly faster than the <code class="docutils literal notranslate"><span class="pre">XZR</span></code> approach. Transposition was not benchmarked, since the dimension swapping happens in the high-level code and not in the assembly code.</p>
</section>
</section>
<section id="identity-primitive">
<h3>4.2.2 Identity Primitive<a class="headerlink" href="#identity-primitive" title="Link to this heading"></a></h3>
<p>This primitive differs slightly from the zero and ReLU primitives.
The identity (or copy) primitive is intended to copy values from the input matrix to the output matrix, while considering for potential transpositions.
Since this does not represent a true first or last touch, we implemented this primitive as an additional main primitive.</p>
<section id="identity-implementation">
<h4>4.2.2.1 Identity Implementation<a class="headerlink" href="#identity-implementation" title="Link to this heading"></a></h4>
<p>Firstly we implemented the general identity for a matrix A.</p>
<p>This approach was mostly straight forward, as we copied our <code class="docutils literal notranslate"><span class="pre">zero_primitive</span></code> kernel and replaced
every ‘zero store’ with:</p>
<ol class="arabic simple">
<li><p>a load from matrix <code class="docutils literal notranslate"><span class="pre">A</span></code> at the specific address, and</p></li>
<li><p>a store, that would store the element from <code class="docutils literal notranslate"><span class="pre">A</span></code> in matrix <code class="docutils literal notranslate"><span class="pre">B</span></code>.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">Identity Primitive: main loop</span><a class="headerlink" href="#id27" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span><span class="p">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&quot;m_8_loop&quot;</span><span class="p">);</span>
<span class="c1">// load and store 8 rows of A and B</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">stp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="c1">// jump by 8 rows</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="c1">// decrement m loop counter</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">sub</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="c1">// check if loop counter is zero</span>
<span class="kt">int</span><span class="w"> </span><span class="n">l_mLoopInstrCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel</span><span class="p">.</span><span class="n">getInstrCountFromLabel</span><span class="p">(</span><span class="s">&quot;m_8_loop&quot;</span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">cbnz</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">l_mLoopInstrCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>For the edge cases where there was a remainder for the <code class="docutils literal notranslate"><span class="pre">m</span></code> dimension, we used the same procedure as before:</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">Identity Primitive: M = 5 edge case</span><a class="headerlink" href="#id28" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldrPost</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">strPost</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">s</span><span class="p">));</span>
<span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
</div>
</section>
<section id="identity-transposition-implementation">
<h4>4.2.2.2 Identity Transposition Implementation<a class="headerlink" href="#identity-transposition-implementation" title="Link to this heading"></a></h4>
<p>After implementing the general identity, we implemented a transposition version.
Our intuition to transpose the identity was to look at the <a class="reference internal" href="03_neon.html#transposition"><span class="std std-ref">4x4 tranposition kernel</span></a>.</p>
<p>We decided to take the 4x4 matrix as our general case.</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">Identity Transposition Primitive: main loop</span><a class="headerlink" href="#id29" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load 4x4 block of A (input matrix)</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>

<span class="c1">// Transpose 4x4 block</span>
<span class="c1">// TRN</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="c1">// ZIP</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="c1">// Store 4x4 Block of B</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>To handle the different stores for <code class="docutils literal notranslate"><span class="pre">4x4</span></code> blocks that are not on the matrix diagonal, we
would do the following:</p>
<p>After processing a <code class="docutils literal notranslate"><span class="pre">4x4</span></code> block on the diagonal:</p>
<ol class="arabic simple">
<li><p>Jump by 4 rows in Matrix A</p></li>
<li><p>Jump by 4 columns in Matrix B</p></li>
</ol>
<p>By using this approach, we would guarantee that after processing a block in the matrix A, we could save it at the correct position in matrix B. For all cases where the <code class="docutils literal notranslate"><span class="pre">m</span></code> dimension is not be divisible by 4, we would need to implement specific kernels.</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">Identity Transposition Primitive: 2x4 edge case</span><a class="headerlink" href="#id30" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>

<span class="c1">// Transpose 2x4 block</span>
<span class="c1">// TRN</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="c1">// ZIP</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="c1">// Store 2x4 Block of B</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>After implementing the edge cases for remainders of <code class="docutils literal notranslate"><span class="pre">m</span></code>, we would be able to process <code class="docutils literal notranslate"><span class="pre">mx4</span></code> blocks of our matrix.</p>
<p>That meant we needed to consider cases where there was a remainder of <code class="docutils literal notranslate"><span class="pre">n</span></code>.
There were two things to consider:</p>
<ol class="arabic simple">
<li><p>The rightmost column (remainder of <code class="docutils literal notranslate"><span class="pre">n</span></code>), which could be: <code class="docutils literal notranslate"><span class="pre">4x3</span></code>, <code class="docutils literal notranslate"><span class="pre">4x2</span></code> or <code class="docutils literal notranslate"><span class="pre">4x1</span></code></p></li>
<li><p>The last piece in the rightmost corner (remainder of <code class="docutils literal notranslate"><span class="pre">m</span></code> and <code class="docutils literal notranslate"><span class="pre">n</span></code>)</p></li>
</ol>
<p>For both of these cases we would consider a similar implementing approach as for the <code class="docutils literal notranslate"><span class="pre">m</span></code> remainder implementation.</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">Identity Transposition Primitive: 4x2 edge case</span><a class="headerlink" href="#id31" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load 4x2 block of A (input matrix)</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldrPost</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">mov</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldrPost</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>

<span class="c1">// Transpose 4x2 matrix</span>
<span class="c1">// TRN</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="c1">// Store 4x2 Block of B</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">d</span><span class="p">));</span>
</pre></div>
</div>
</div>
</section>
<section id="benchmarks-the-identity-kernel-performance">
<h4>4.2.2.3 Benchmarks the Identity Kernel Performance<a class="headerlink" href="#benchmarks-the-identity-kernel-performance" title="Link to this heading"></a></h4>
<p>We benchmarked the performance of our identity primitive for the given parameters (M=N=50, M=N=64, M=N=512 and M=N=2048) and obtained the following results:</p>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for the identity primitives</span><a class="headerlink" href="#id32" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Running identity_primitive 50x50 benchmark
Total time (s):                       3
Total reps:                           20635000
Total number of elements:             51587500000
Total amount of processed data (GiB): 384.357
Bandwidth (GiB/s)                     128.119
--------------------------------------------------
Running identity_primitive 64x64 benchmark
Total time (s):                       3
Total reps:                           14687433
Total number of elements:             60159725568
Total amount of processed data (GiB): 448.225
Bandwidth (GiB/s)                     149.408
--------------------------------------------------
Running identity_primitive 512x512 benchmark
Total time (s):                       3
Total reps:                           186337
Total number of elements:             48847126528
Total amount of processed data (GiB): 363.939
Bandwidth (GiB/s)                     121.313
--------------------------------------------------
Running identity_primitive 2048x2048 benchmark
Total time (s):                       3.00001
Total reps:                           9976
Total number of elements:             41842376704
Total amount of processed data (GiB): 311.75
Bandwidth (GiB/s)                     103.916
--------------------------------------------------
Running identity_trans_primitive 50x50 benchmark
Total time (s):                       3
Total reps:                           17759330
Total number of elements:             44398325000
Total amount of processed data (GiB): 330.793
Bandwidth (GiB/s)                     110.264
--------------------------------------------------
Running identity_trans_primitive 64x64 benchmark
Total time (s):                       3
Total reps:                           11603499
Total number of elements:             47527931904
Total amount of processed data (GiB): 354.111
Bandwidth (GiB/s)                     118.037
--------------------------------------------------
Running identity_trans_primitive 512x512 benchmark
Total time (s):                       3.00044
Total reps:                           6236
Total number of elements:             1634729984
Total amount of processed data (GiB): 12.1797
Bandwidth (GiB/s)                     4.0593
--------------------------------------------------
Running identity_trans_primitive 2048x2048 benchmark
Total time (s):                       3.00888
Total reps:                           347
Total number of elements:             1455423488
Total amount of processed data (GiB): 10.8438
Bandwidth (GiB/s)                     3.60391
--------------------------------------------------
</pre></div>
</div>
</div>
<p>Most notably, we can see that the performance of the transposition kernel is significantly lower for larger matrices, such as 512x512 and 2048x2048. Here, we achieved a bandwidth of only 3.6 to 4 GiB/s, while all other configurations achieved bandwidths greater than 100 GiB/s.</p>
</section>
</section>
<section id="relu-primitive">
<span id="id5"></span><h3>4.2.3 ReLU Primitive<a class="headerlink" href="#relu-primitive" title="Link to this heading"></a></h3>
<p>The last unary primitive we implemented was the ReLU primitive, a commonly employed function machine learning models.
The Rectified Linear Unit activation function is defined as: <code class="docutils literal notranslate"><span class="pre">f(x)</span> <span class="pre">=</span> <span class="pre">max(0,</span> <span class="pre">x)</span></code>, meaning that all negative values are set to zero and all positive values are kept as they are.</p>
<section id="relu-primitive-implementation">
<h4>4.2.3.1 ReLU Primitive Implementation<a class="headerlink" href="#relu-primitive-implementation" title="Link to this heading"></a></h4>
<p>To implement this, we first had to add support for the <code class="docutils literal notranslate"><span class="pre">FMAX</span></code> instruction, which computes the maximum of two values. Using the <code class="docutils literal notranslate"><span class="pre">EOR</span></code> instruction which we implemented for the zero primitive, we can create a zero register and then use the <code class="docutils literal notranslate"><span class="pre">FMAX</span></code> instruction to compute the maximum of the input value and zero. Since the primitive should also support transposition, we implemented two versions.</p>
<p>The first version does not transpose the output and is structurally the same as the zero primitive. However instead of always storing zero, we now store the maximum of the input value and zero.</p>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">ReLU Primitive: main loop</span><a class="headerlink" href="#id33" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span><span class="p">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&quot;m_8_loop&quot;</span><span class="p">);</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">({</span>
<span class="c1">// load 8 elements from A</span>
<span class="n">simd_fp</span><span class="o">::</span><span class="n">ldp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">),</span>
<span class="c1">// compute f(x)=max(x,0)</span>
<span class="n">simd_fp</span><span class="o">::</span><span class="n">fmax</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">),</span>
<span class="n">simd_fp</span><span class="o">::</span><span class="n">fmax</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">),</span>
<span class="c1">// store 8 elements to B</span>
<span class="n">simd_fp</span><span class="o">::</span><span class="n">stp</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">),</span>
<span class="c1">// jump by 8 rows</span>
<span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="c1">// decrement m loop counter</span>
<span class="n">base</span><span class="o">::</span><span class="n">sub</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="p">});</span>
<span class="c1">// check if loop counter is zero</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">cbnz</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">kernel</span><span class="p">.</span><span class="n">getInstrCountFromLabel</span><span class="p">(</span><span class="s">&quot;m_8_loop&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>To support transposition, we started with the identity transposition primitive. The only addition we had to make was to add the <code class="docutils literal notranslate"><span class="pre">FMAX</span></code> instruction between the load and store instructions. The rest of the implementation is structurally identical to the identity transposition primitive. The difference can be seen in the following code snippets:</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">Original transposition code (identity_trans_primitive)</span><a class="headerlink" href="#id34" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load 4x4 block of A (input matrix)</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>

<span class="c1">// Transpose 4x4 block</span>
<span class="c1">// TRN</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="c1">// ZIP</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-text">Code with the FMAX instruction (relu_trans_primitive)</span><a class="headerlink" href="#id35" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load 4x4 block of A (input matrix)</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">ldr</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">gpr_t</span><span class="o">::</span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">neon_size_spec_t</span><span class="o">::</span><span class="n">q</span><span class="p">));</span>

<span class="c1">// Compute ReLU</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmax</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmax</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmax</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">fmax</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="c1">// Transpose 4x4 block</span>
<span class="c1">// TRN</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">trn2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="c1">// ZIP</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip1</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>

<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
<span class="n">kernel</span><span class="p">.</span><span class="n">add_instr</span><span class="p">(</span><span class="n">simd_fp</span><span class="o">::</span><span class="n">zip2</span><span class="p">(</span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">simd_fp_t</span><span class="o">::</span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">arr_spec_t</span><span class="o">::</span><span class="n">s4</span><span class="p">));</span>
</pre></div>
</div>
</div>
</section>
<section id="relu-primitive-benchmarks">
<h4>4.2.3.2 ReLU Primitive Benchmarks<a class="headerlink" href="#relu-primitive-benchmarks" title="Link to this heading"></a></h4>
<p>We benchmarked the performance of our ReLU primitive for the given parameters (M=N=50, M=N=64, M=N=512 and M=N=2048), and obtained the following results:</p>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for the relu primitives</span><a class="headerlink" href="#id36" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Running relu_primitive 50x50 benchmark
Total time (s):                       3
Total reps:                           19774014
Total number of elements:             49435035000
Total amount of processed data (GiB): 368.32
Bandwidth (GiB/s)                     122.773
--------------------------------------------------
Running relu_primitive 64x64 benchmark
Total time (s):                       3
Total reps:                           12192431
Total number of elements:             49940197376
Total amount of processed data (GiB): 372.083
Bandwidth (GiB/s)                     124.028
--------------------------------------------------
Running relu_primitive 512x512 benchmark
Total time (s):                       3.00001
Total reps:                           179693
Total number of elements:             47105441792
Total amount of processed data (GiB): 350.963
Bandwidth (GiB/s)                     116.987
--------------------------------------------------
Running relu_primitive 2048x2048 benchmark
Total time (s):                       3.00018
Total reps:                           8874
Total number of elements:             37220253696
Total amount of processed data (GiB): 277.312
Bandwidth (GiB/s)                     92.4321
--------------------------------------------------
Running relu_trans_primitive 50x50 benchmark
Total time (s):                       3
Total reps:                           16995447
Total number of elements:             42488617500
Total amount of processed data (GiB): 316.565
Bandwidth (GiB/s)                     105.522
--------------------------------------------------
Running relu_trans_primitive 64x64 benchmark
Total time (s):                       3
Total reps:                           11039409
Total number of elements:             45217419264
Total amount of processed data (GiB): 336.896
Bandwidth (GiB/s)                     112.299
--------------------------------------------------
Running relu_trans_primitive 512x512 benchmark
Total time (s):                       3.00018
Total reps:                           6131
Total number of elements:             1607204864
Total amount of processed data (GiB): 11.9746
Bandwidth (GiB/s)                     3.9913
--------------------------------------------------
Running relu_trans_primitive 2048x2048 benchmark
Total time (s):                       3.00082
Total reps:                           347
Total number of elements:             1455423488
Total amount of processed data (GiB): 10.8438
Bandwidth (GiB/s)                     3.6136
--------------------------------------------------
</pre></div>
</div>
</div>
<p>The results match the pattern we saw for the zero and identity primitives. The transposition version is significantly slower than the non-transposition version, especially for larger matrices. Here as well, the 2048x2048 benchmark achieved worse results than the smaller matrices, both with and without transposition.</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="03_neon.html" class="btn btn-neutral float-left" title="3. Neon" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="05_tensor_op.html" class="btn btn-neutral float-right" title="5. Tensor Operation Backend" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lucas Obitz, Luca-Philipp Grumbach.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>