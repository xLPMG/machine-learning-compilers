

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. Neon &mdash; Machine Learning Compilers  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. Code Generation" href="04_code_gen.html" />
    <link rel="prev" title="2. Base" href="02_base.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Machine Learning Compilers
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Project Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/01_project_information.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/02_project_report.html">Project Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/03_user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/04_docu_setup.html">Documentation Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Submissions</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_assembly.html">1. Assembly</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_base.html">2. Base</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Neon</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#execution-throughput-and-latency">3.1 Execution Throughput and Latency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#throughput">3.1.1 Throughput</a></li>
<li class="toctree-l3"><a class="reference internal" href="#latency">3.1.2 Latency</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#microkernel">3.2 Microkernel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#neon-microkernel">3.2.1 Neon Microkernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-and-benchmarking">3.2.2 Testing and Benchmarking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#loops">3.3 Loops</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#loop-implementations">3.3.1 Loop Implementations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">3.3.2 Testing and Benchmarking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#simd-lanes">3.4 SIMD Lanes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#matmul-14-6-64">3.4.1 Matmul_14_6_64</a></li>
<li class="toctree-l3"><a class="reference internal" href="#matmul-15-6-64">3.4.2 Matmul_15_6_64</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generic-approach">3.4.3 Generic Approach</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#accumulator-block-shapes">3.5 Accumulator Block Shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#batch-reduce-gemm">3.6 Batch-Reduce GEMM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transposition">3.7 Transposition</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#transposition-implementation">3.7.1 Transposition Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance-measuring">3.7.2 Performance Measuring</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="04_code_gen.html">4. Code Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_tensor_op.html">5. Tensor Operation Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_einsum.html">6. Einsum Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_individual_phase.html">7. Individual Phase</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit.html">mini_jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_benchmarks.html">mini_jit::benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_converters.html">mini_jit::converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_einsum.html">mini_jit::einsum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_instructions.html">mini_jit::instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_ir.html">mini_jit::ir</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_kernels.html">mini_jit::kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_registers.html">mini_jit::registers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Machine Learning Compilers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">3. Neon</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/submissions/03_neon.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="neon">
<span id="id1"></span><h1>3. Neon<a class="headerlink" href="#neon" title="Link to this heading"></a></h1>
<p>In this section we explore <a class="reference external" href="https://developer.arm.com/Architectures/Neon">Neon</a>, ARM’s advanced SIMD (Single Instruction, Multiple Data) architecture extension. Our goal is to understand how to implement Neon kernels and how to optimize them for maximum performance.</p>
<section id="execution-throughput-and-latency">
<span id="throughput-latency"></span><h2>3.1 Execution Throughput and Latency<a class="headerlink" href="#execution-throughput-and-latency" title="Link to this heading"></a></h2>
<p>The first task was to benchmark the execution throughput and latency of some selected FP32 Neon instructions.
Specifically, we were looking at:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://developer.arm.com/documentation/ddi0602/2025-03/SIMD-FP-Instructions/FMLA--vector---Floating-point-fused-multiply-add-to-accumulator--vector--">FMLA (vector)</a> instruction</p></li>
<li><p><a class="reference external" href="https://developer.arm.com/documentation/ddi0602/2025-03/SIMD-FP-Instructions/FMADD--Floating-point-fused-multiply-add--scalar--?lang=en">FMADD (scalar)</a> instruction</p></li>
</ol>
<section id="throughput">
<h3>3.1.1 Throughput<a class="headerlink" href="#throughput" title="Link to this heading"></a></h3>
<p>To analyze the throughput, we compared the performance of the following variants:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(vector)</span></code> with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(vector)</span></code> with arrangement specifier <code class="docutils literal notranslate"><span class="pre">2S</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FMADD</span> <span class="pre">(scalar)</span></code>, single-precision variant</p></li>
</ol>
<p>To compare the throughput of these variants, we created an assembly program for each of them.
To ensure instruction-level parallelism, we carefully designed the inner loops of these programs to avoid register dependencies between successive instructions.
The calculations and loop structures we used are shown here:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(vector)</span></code> with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code></span><a class="headerlink" href="#id9" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">31</span><span class="nl">loop:</span>
<span class="linenos">32</span><span class="w">    </span><span class="na">.rept</span><span class="w"> </span><span class="mi">100</span>
<span class="linenos">33</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.4s</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v1.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span>
<span class="linenos">37</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v20.4s</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.4s</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.4s</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.4s</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span>
<span class="linenos">46</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.4s</span>
<span class="linenos">48</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.4s</span>
<span class="linenos">49</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.4s</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v31.4s</span>
<span class="linenos">52</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.4s</span>
<span class="linenos">53</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span>
<span class="linenos">54</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.4s</span>
<span class="linenos">55</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.4s</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.4s</span>
<span class="linenos">58</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v5.4s</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v6.4s</span>
<span class="linenos">60</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v31.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v7.4s</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v8.4s</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.4s</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.4s</span>
<span class="linenos">65</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.4s</span>
<span class="linenos">66</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v28.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span>
<span class="linenos">67</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v29.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span>
<span class="linenos">68</span>
<span class="linenos">69</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v30.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span>
<span class="linenos">70</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v31.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span>
<span class="linenos">71</span><span class="w">    </span><span class="na">.endr</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(vector)</span></code> with arrangement specifier <code class="docutils literal notranslate"><span class="pre">2S</span></code></span><a class="headerlink" href="#id10" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">31</span><span class="nl">loop:</span>
<span class="linenos">32</span><span class="w">    </span><span class="na">.rept</span><span class="w"> </span><span class="mi">100</span>
<span class="linenos">33</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v0.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v8.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.2s</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v1.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.2s</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v2.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.2s</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.2s</span>
<span class="linenos">37</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v4.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v20.2s</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v5.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.2s</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v6.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.2s</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.2s</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.2s</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.2s</span>
<span class="linenos">46</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v20.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.2s</span>
<span class="linenos">48</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.2s</span>
<span class="linenos">49</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.2s</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v31.2s</span>
<span class="linenos">52</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.2s</span>
<span class="linenos">53</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.2s</span>
<span class="linenos">54</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.2s</span>
<span class="linenos">55</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.2s</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.2s</span>
<span class="linenos">58</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v5.2s</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v6.2s</span>
<span class="linenos">60</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v31.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v7.2s</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v8.2s</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v25.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.2s</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v26.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.2s</span>
<span class="linenos">65</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.2s</span>
<span class="linenos">66</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v28.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.2s</span>
<span class="linenos">67</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v29.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v5.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.2s</span>
<span class="linenos">68</span>
<span class="linenos">69</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v30.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v6.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.2s</span>
<span class="linenos">70</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v31.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.2s</span>
<span class="linenos">71</span><span class="w">    </span><span class="na">.endr</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">FMADD</span> <span class="pre">(scalar)</span></code>, single-precision variant</span><a class="headerlink" href="#id11" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">39</span><span class="nl">loop:</span>
<span class="linenos">40</span><span class="w">    </span><span class="na">.rept</span><span class="w"> </span><span class="mi">100</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="w">  </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="no">s16</span><span class="p">,</span><span class="w"> </span><span class="no">s24</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s1</span><span class="p">,</span><span class="w">  </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="no">s17</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="no">s10</span><span class="p">,</span><span class="w"> </span><span class="no">s18</span><span class="p">,</span><span class="w"> </span><span class="no">s26</span>
<span class="linenos">44</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="no">s19</span><span class="p">,</span><span class="w"> </span><span class="no">s27</span>
<span class="linenos">45</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s4</span><span class="p">,</span><span class="w"> </span><span class="no">s12</span><span class="p">,</span><span class="w"> </span><span class="no">s20</span><span class="p">,</span><span class="w"> </span><span class="no">s28</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="no">s13</span><span class="p">,</span><span class="w"> </span><span class="no">s21</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span>
<span class="linenos">48</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s6</span><span class="p">,</span><span class="w"> </span><span class="no">s14</span><span class="p">,</span><span class="w"> </span><span class="no">s22</span><span class="p">,</span><span class="w"> </span><span class="no">s30</span>
<span class="linenos">49</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="no">s15</span><span class="p">,</span><span class="w"> </span><span class="no">s23</span><span class="p">,</span><span class="w"> </span><span class="no">s31</span>
<span class="linenos">50</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="no">s16</span><span class="p">,</span><span class="w"> </span><span class="no">s24</span><span class="p">,</span><span class="w"> </span><span class="no">s0</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="no">s17</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s1</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s10</span><span class="p">,</span><span class="w"> </span><span class="no">s18</span><span class="p">,</span><span class="w"> </span><span class="no">s26</span><span class="p">,</span><span class="w"> </span><span class="no">s2</span>
<span class="linenos">54</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="no">s19</span><span class="p">,</span><span class="w"> </span><span class="no">s27</span><span class="p">,</span><span class="w"> </span><span class="no">s3</span>
<span class="linenos">55</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s12</span><span class="p">,</span><span class="w"> </span><span class="no">s20</span><span class="p">,</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w"> </span><span class="no">s4</span>
<span class="linenos">56</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s13</span><span class="p">,</span><span class="w"> </span><span class="no">s21</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s5</span>
<span class="linenos">57</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s14</span><span class="p">,</span><span class="w"> </span><span class="no">s22</span><span class="p">,</span><span class="w"> </span><span class="no">s30</span><span class="p">,</span><span class="w"> </span><span class="no">s6</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s15</span><span class="p">,</span><span class="w"> </span><span class="no">s23</span><span class="p">,</span><span class="w"> </span><span class="no">s31</span><span class="p">,</span><span class="w"> </span><span class="no">s7</span>
<span class="linenos">60</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s16</span><span class="p">,</span><span class="w"> </span><span class="no">s24</span><span class="p">,</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="no">s8</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s17</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w">  </span><span class="no">s1</span><span class="p">,</span><span class="w"> </span><span class="no">s9</span>
<span class="linenos">62</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s18</span><span class="p">,</span><span class="w"> </span><span class="no">s26</span><span class="p">,</span><span class="w">  </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="no">s10</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s19</span><span class="p">,</span><span class="w"> </span><span class="no">s27</span><span class="p">,</span><span class="w">  </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="no">s11</span>
<span class="linenos">64</span>
<span class="linenos">65</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s20</span><span class="p">,</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w">  </span><span class="no">s4</span><span class="p">,</span><span class="w"> </span><span class="no">s12</span>
<span class="linenos">66</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s21</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w">  </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="no">s13</span>
<span class="linenos">67</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s22</span><span class="p">,</span><span class="w"> </span><span class="no">s30</span><span class="p">,</span><span class="w">  </span><span class="no">s6</span><span class="p">,</span><span class="w"> </span><span class="no">s14</span>
<span class="linenos">68</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s23</span><span class="p">,</span><span class="w"> </span><span class="no">s31</span><span class="p">,</span><span class="w">  </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="no">s15</span>
<span class="linenos">69</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s24</span><span class="p">,</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="w">  </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="no">s16</span>
<span class="linenos">70</span>
<span class="linenos">71</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w">  </span><span class="no">s1</span><span class="p">,</span><span class="w">  </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="no">s17</span>
<span class="linenos">72</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s26</span><span class="p">,</span><span class="w">  </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="no">s10</span><span class="p">,</span><span class="w"> </span><span class="no">s18</span>
<span class="linenos">73</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s27</span><span class="p">,</span><span class="w">  </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="no">s19</span>
<span class="linenos">74</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w">  </span><span class="no">s4</span><span class="p">,</span><span class="w"> </span><span class="no">s12</span><span class="p">,</span><span class="w"> </span><span class="no">s20</span>
<span class="linenos">75</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w">  </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="no">s13</span><span class="p">,</span><span class="w"> </span><span class="no">s21</span>
<span class="linenos">76</span>
<span class="linenos">77</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s30</span><span class="p">,</span><span class="w">  </span><span class="no">s6</span><span class="p">,</span><span class="w"> </span><span class="no">s14</span><span class="p">,</span><span class="w"> </span><span class="no">s22</span>
<span class="linenos">78</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s31</span><span class="p">,</span><span class="w">  </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="no">s15</span><span class="p">,</span><span class="w"> </span><span class="no">s23</span>
<span class="linenos">79</span><span class="w">    </span><span class="na">.endr</span>
<span class="linenos">80</span>
<span class="linenos">81</span><span class="w">    </span><span class="nf">subs</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">82</span><span class="w">    </span><span class="nf">b.gt</span><span class="w"> </span><span class="no">loop</span>
</pre></div>
</div>
</div>
<p>We then implemented a C++ microbenchmark to evaluate each version.
For each function, we:</p>
<ol class="arabic simple">
<li><p>Performed a warm-up</p></li>
<li><p>Measured the execution time</p></li>
<li><p>Counted the number of operations</p></li>
<li><p>Calculated the resulting GFLOPs</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">Example benchmark for <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">4S</span></code></span><a class="headerlink" href="#id12" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">61</span><span class="w">        </span><span class="c1">// Warmup</span>
<span class="linenos">62</span><span class="w">        </span><span class="n">fmla_4s_instr</span><span class="p">(</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">g_4s_registers</span><span class="w"> </span><span class="p">);</span>
<span class="linenos">63</span>
<span class="linenos">64</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">l_start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="linenos">65</span><span class="w">        </span><span class="n">fmla_4s_instr</span><span class="p">(</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">g_4s_registers</span><span class="w"> </span><span class="p">);</span>
<span class="linenos">66</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">l_end_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="linenos">67</span><span class="w">        </span><span class="n">elapsedTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span><span class="n">l_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_start_time</span><span class="w"> </span><span class="p">).</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span>
<span class="linenos">68</span>
<span class="linenos">69</span><span class="w">        </span><span class="c1">// per FMLA: 4 Muls, 4 Adds</span>
<span class="linenos">70</span><span class="w">        </span><span class="c1">// 32 fmla</span>
<span class="linenos">71</span><span class="w">        </span><span class="c1">// rept 100</span>
<span class="linenos">72</span><span class="w">        </span><span class="c1">// n: loop iterations</span>
<span class="linenos">73</span><span class="w">        </span><span class="n">totalOps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Calculations for <code class="docutils literal notranslate"><span class="pre">2S</span></code> and <code class="docutils literal notranslate"><span class="pre">FMADD</span> <span class="pre">(scalar)</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">Calculations for <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">2S</span></code></span><a class="headerlink" href="#id13" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">85</span><span class="w">        </span><span class="c1">// per FMLA: 2 Muls, 2 Adds</span>
<span class="linenos">86</span><span class="w">        </span><span class="c1">// 32 fmla</span>
<span class="linenos">87</span><span class="w">        </span><span class="c1">// rept 100</span>
<span class="linenos">88</span><span class="w">        </span><span class="c1">// n: loop iterations</span>
<span class="linenos">89</span><span class="w">        </span><span class="n">totalOps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">Calculations for <code class="docutils literal notranslate"><span class="pre">FMADD</span></code></span><a class="headerlink" href="#id14" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">101</span><span class="w">        </span><span class="c1">// per FMADD: 1 Mul, 1 Add</span>
<span class="linenos">102</span><span class="w">        </span><span class="c1">// 32 fmadd</span>
<span class="linenos">103</span><span class="w">        </span><span class="c1">// rept 100</span>
<span class="linenos">104</span><span class="w">        </span><span class="c1">// n: loop iterations</span>
<span class="linenos">105</span><span class="w">        </span><span class="n">totalOps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>The measured throughput results we obtained were as follows:</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">Measured Throughput Results</span><a class="headerlink" href="#id15" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking FMLA 4s throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for FMLA_4sInstruction
<span class="linenos"> 4</span>Total time (s):   1.96706
<span class="linenos"> 5</span>Instructions per Second:   1.30144e+11
<span class="linenos"> 6</span>Estimated GOPS:   130.144 GFLOPs/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking FMLA 2s throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for FMLA_2sInstruction
<span class="linenos">12</span>Total time (s):   2.53647
<span class="linenos">13</span>Instructions per Second:   5.04638e+10
<span class="linenos">14</span>Estimated GOPS:   50.4638 GFLOPs/sec
<span class="linenos">15</span>-----------------------------------------------
<span class="linenos">16</span>
<span class="linenos">17</span>Benchmarking FMADD throughput ...
<span class="linenos">18</span>-----------------------------------------------
<span class="linenos">19</span>Measuring throughput for FMADDInstruction
<span class="linenos">20</span>Total time (s):   3.52918
<span class="linenos">21</span>Instructions per Second:   1.81345e+10
<span class="linenos">22</span>Estimated GOPS:   18.1345 GFLOPs/sec
<span class="linenos">23</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>We observe that:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">4S</span></code> achieves approximately <code class="docutils literal notranslate"><span class="pre">2.5</span></code> times the performance of <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">2S</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">2S</span></code> similarly outperforms <code class="docutils literal notranslate"><span class="pre">FMADD</span> <span class="pre">(scalar)</span></code> by a factor of <code class="docutils literal notranslate"><span class="pre">2.5</span></code></p></li>
</ul>
<p>These results highlight the benefit of data-level parallelism through vector operations. The higher the vector width, the more operations are performed per instruction, therefore resulting in a significantly improved throughput compared to a scalar execution.</p>
</section>
<section id="latency">
<h3>3.1.2 Latency<a class="headerlink" href="#latency" title="Link to this heading"></a></h3>
<p>To analyze the execution latency of the <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">vector</span></code> instruction with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code>, we considered two dependency scenarios:</p>
<ol class="arabic simple">
<li><p>Each instruction depends on the destination register <strong>and</strong> one source register of the previous instruction.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">FMLA</span></code> instructions with dependencies on the destination and one source registers</span><a class="headerlink" href="#id16" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.4s</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.4s</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.4s</span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Each instruction depends <strong>only</strong> on the destination register of the previous instruction</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">FMLA</span></code> instructions with dependency only on the destination register</span><a class="headerlink" href="#id17" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.4s</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.4s</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.4s</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span>
</pre></div>
</div>
</div>
<p>In both cases, 32 dependent <code class="docutils literal notranslate"><span class="pre">FMLA</span></code> instructions were executed in a loop, repeated 100 times.
The results for both cases are shown below:</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">Latency benchmark results for the two dependency scenarios</span><a class="headerlink" href="#id18" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">25</span>Benchmarking FMLA 4s source register latency ...
<span class="linenos">26</span>-----------------------------------------------
<span class="linenos">27</span>Measuring latency for FMLA_SourceInstruction
<span class="linenos">28</span>Total time (s):   3.30277
<span class="linenos">29</span>Instructions per Second:   1.16266e+10
<span class="linenos">30</span>Estimated GOPS:   11.6266 GFLOPs/sec
<span class="linenos">31</span>-----------------------------------------------
<span class="linenos">32</span>
<span class="linenos">33</span>Benchmarking FMLA 4s destination register latency ...
<span class="linenos">34</span>-----------------------------------------------
<span class="linenos">35</span>Measuring latency for FMLA_DestinationInstruction
<span class="linenos">36</span>Total time (s):   3.30207
<span class="linenos">37</span>Instructions per Second:   1.16291e+10
<span class="linenos">38</span>Estimated GOPS:   11.6291 GFLOPs/sec
<span class="linenos">39</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>We observed that both scenarios produced nearly identical performance results. Therefore, we focused our latency calculations only on the first scenario.</p>
<p>From our measurement, we got <span class="math notranslate nohighlight">\(1.16266 \times 10^{10}\)</span> instructions per second.
This yields a per-instruction latency of approximately <span class="math notranslate nohighlight">\(\frac{1}{1.16266 \times 10^{10}} \approx 8.6 \times 10^{-11}\)</span> seconds.
Assuming a clock frequency of <code class="docutils literal notranslate"><span class="pre">4.4</span></code> GHz, we estimated the latency in clock cycles as <span class="math notranslate nohighlight">\(8.6 \times 10^{-11} \times 4.4 \times 10^9 = 0.3784\)</span> cycles.</p>
<p>This value suggests that the latency of a single <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">4S</span></code> instruction is well below one clock cycle.</p>
</section>
</section>
<section id="microkernel">
<span id="id3"></span><h2>3.2 Microkernel<a class="headerlink" href="#microkernel" title="Link to this heading"></a></h2>
<p>For the second task, we implemented a Neon-based microkernel to perform a matrix-matrix multiplication with the following dimensions:</p>
<ol class="arabic simple">
<li><p>Matrix A: <code class="docutils literal notranslate"><span class="pre">16</span> <span class="pre">x</span> <span class="pre">1</span></code></p></li>
<li><p>Matrix B: <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">x</span> <span class="pre">6</span></code></p></li>
<li><p>Matrix C: <code class="docutils literal notranslate"><span class="pre">16</span> <span class="pre">x</span> <span class="pre">6</span></code></p></li>
</ol>
<p>For the task we were provided with the following C function signature:</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">Function Signature</span><a class="headerlink" href="#id19" title="Link to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * @brief GEMM that computes: C+=AB.</span>
<span class="cm"> * @param a    Pointer to column-major matrix A.</span>
<span class="cm"> * @param b    Pointer to column-major matrix B.</span>
<span class="cm"> * @param c    Pointer to column-major matrix C.</span>
<span class="cm"> * @param ld_a Leading dimension of A.</span>
<span class="cm"> * @param ld_b Leading dimension of B.</span>
<span class="cm"> * @param ld_c Leading dimension of C.</span>
<span class="cm"> **/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">matmul_16_6_1</span><span class="p">(</span><span class="w"> </span><span class="kt">float</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">float</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">float</span><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">int64_t</span><span class="w">         </span><span class="n">ld_a</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">int64_t</span><span class="w">         </span><span class="n">ld_b</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">int64_t</span><span class="w">         </span><span class="n">ld_c</span><span class="w"> </span><span class="p">);</span>
</pre></div>
</div>
</div>
<section id="neon-microkernel">
<h3>3.2.1 Neon Microkernel<a class="headerlink" href="#neon-microkernel" title="Link to this heading"></a></h3>
<p>We developed three different versions of this microkernel. With each version, we wanted to compare different data-loading, register usage and data reuse strategies:</p>
<p>The <strong>first version</strong>:</p>
<ol class="arabic simple">
<li><p>Load the entire Matrix A (16 x 1)</p></li>
<li><p>Load <strong>three</strong> individual elements (1 x 1) of Matrix B</p></li>
<li><p>Load the entire Matrix C (16 x 6)</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/Shad00Z/machine-learning-compilers/blob/main/src/submissions/03_neon/02_microkernel/benchmark/b1_matmul_16_6_1.s">b1_matmul_16_6_1.s</a></span><a class="headerlink" href="#id20" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Load 3 elements of B</span>
<span class="cm"> */</span>
<span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w">              </span><span class="c1">// current column of B</span>

<span class="nf">ldr</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x6</span><span class="p">]</span><span class="w">           </span><span class="c1">// Column B(0)</span>
<span class="nf">add</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>

<span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x6</span><span class="p">]</span><span class="w">           </span><span class="c1">// Column B(1)</span>
<span class="nf">add</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>

<span class="nf">ldr</span><span class="w"> </span><span class="no">s30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x6</span><span class="p">]</span><span class="w">           </span><span class="c1">// Column B(2)</span>
<span class="nf">add</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>

<span class="cm">/*</span>
<span class="cm"> * Multiply and accumulate (1 / 2)</span>
<span class="cm"> */</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nf">fmla</span><span class="w"> </span><span class="no">v8.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v9.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>The <strong>second version</strong>:</p>
<ol class="arabic simple">
<li><p>Load the entire Matrix A (16 x 1)</p></li>
<li><p>Load <strong>one</strong> element of Matrix B</p></li>
<li><p>Load the entire Matrix C (16 x 6)</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/Shad00Z/machine-learning-compilers/blob/main/src/submissions/03_neon/02_microkernel/benchmark/b2_matmul_16_6_1.s">b2_matmul_16_6_1.s</a></span><a class="headerlink" href="#id21" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Load column of B (1 / 6)</span>
<span class="cm"> */</span>
<span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w">              </span><span class="c1">// current column of B</span>

<span class="nf">ldr</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x6</span><span class="p">]</span><span class="w">           </span><span class="c1">// Column B(0)</span>
<span class="nf">add</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>

<span class="cm">/*</span>
<span class="cm"> * Multiply and accumulate (1 / 6)</span>
<span class="cm"> */</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>The <strong>third version</strong>:</p>
<ol class="arabic simple">
<li><p>Load the entire Matrix A (16 x 1)</p></li>
<li><p>Load <strong>one</strong> column of Matrix B</p></li>
<li><p>Load <strong>one</strong> column of Matrix C (16 x 1)</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/Shad00Z/machine-learning-compilers/blob/main/src/submissions/03_neon/02_microkernel/benchmark/b3_matmul_16_6_1.s">b3_matmul_16_6_1.s</a></span><a class="headerlink" href="#id22" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Matrix C: Column 0</span>
<span class="cm"> */</span>
<span class="c1">// Load column of B</span>
<span class="nf">ldr</span><span class="w"> </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x6</span><span class="p">]</span>

<span class="c1">// Load column of C</span>
<span class="nf">ldp</span><span class="w"> </span><span class="no">q4</span><span class="p">,</span><span class="w"> </span><span class="no">q5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="nf">ldp</span><span class="w"> </span><span class="no">q6</span><span class="p">,</span><span class="w"> </span><span class="no">q7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>

<span class="c1">// Multiply and accumulate</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v8.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v8.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v8.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v8.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">// Store column of C</span>
<span class="nf">stp</span><span class="w"> </span><span class="no">q4</span><span class="p">,</span><span class="w"> </span><span class="no">q5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="nf">stp</span><span class="w"> </span><span class="no">q6</span><span class="p">,</span><span class="w"> </span><span class="no">q7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="testing-and-benchmarking">
<h3>3.2.2 Testing and Benchmarking<a class="headerlink" href="#testing-and-benchmarking" title="Link to this heading"></a></h3>
<p>To validate and compare our implementations, we took the following steps:</p>
<ol class="arabic simple">
<li><p>We developed a basic <a class="reference external" href="https://github.com/Shad00Z/machine-learning-compilers/blob/main/src/submissions/03_neon/02_microkernel/benchmark/microbench.cpp">kernel driver</a> to inspect our output correctness visually</p></li>
<li><p>We used Catch2 to verify the correctness of our implementations</p></li>
<li><p>We implemented a benchmark to measure <code class="docutils literal notranslate"><span class="pre">GFLOPs</span></code> for all three versions</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">GFLOPs</span></code> were calculated with the following formula:</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">GFLOPs</span></code> calculation</span><a class="headerlink" href="#id23" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">totalOps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">opsPerIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">totalOps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">loopIterations</span><span class="p">;</span>

<span class="kt">double</span><span class="w"> </span><span class="n">opsPerSec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opsPerIteration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">elapsedTime</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opsPerIteration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">elapsedTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e9</span><span class="w"> </span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Each kernel was executed with <code class="docutils literal notranslate"><span class="pre">50,000</span></code> warmup iterations to reduce variability and ensure fair comparisons.
The benchmark produced the following performance results:</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">GFLOPs</span></code> results for all three versions</span><a class="headerlink" href="#id24" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Benchmarking V1 Matmul throughput ...
-----------------------------------------------
Measuring throughput for Instruction
Total time (s):   2.93595
Instructions per Second:   3.26981e+10
Estimated GFLOPS:   32.6981 GFLOPS/sec
-----------------------------------------------

Benchmarking V2 Matmul throughput ...
-----------------------------------------------
Measuring throughput for Instruction
Total time (s):   2.90291
Instructions per Second:   3.30702e+10
Estimated GFLOPS:   33.0702 GFLOPS/sec
-----------------------------------------------

Benchmarking V3 Matmul throughput ...
-----------------------------------------------
Measuring throughput for Instruction
Total time (s):   2.79132
Instructions per Second:   3.43923e+10
Estimated GFLOPS:   34.3923 GFLOPS/sec
-----------------------------------------------
</pre></div>
</div>
</div>
<p>The results show that performance improved incrementally with each version. The best-performing kernel outperformed the least-performing by approximately <code class="docutils literal notranslate"><span class="pre">1.7</span> <span class="pre">GFLOPs</span></code>, highlighting the importance of careful memory and register management.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even though the third implementation achieved the best performance, it is tailored specifically to the given matrix dimensions. As the <code class="docutils literal notranslate"><span class="pre">K</span></code> dimension increases, the kernel would repeatedly reload columns of matrix <code class="docutils literal notranslate"><span class="pre">C</span></code>, leading to significant performance degradation.</p>
</div>
</section>
</section>
<section id="loops">
<span id="id4"></span><h2>3.3 Loops<a class="headerlink" href="#loops" title="Link to this heading"></a></h2>
<p>After implementing and benchmarking our initial <code class="docutils literal notranslate"><span class="pre">16x6x1</span></code> Neon microkernel, the next step was to scale this kernel for the use with larger matrices. To achieve this, we extended the kernel along the three matrix dimensions <code class="docutils literal notranslate"><span class="pre">K</span></code>, <code class="docutils literal notranslate"><span class="pre">M</span></code>, and <code class="docutils literal notranslate"><span class="pre">N</span></code>, by introducing loops around our base kernel.</p>
<section id="loop-implementations">
<h3>3.3.1 Loop Implementations<a class="headerlink" href="#loop-implementations" title="Link to this heading"></a></h3>
<p>Our <strong>first</strong> step was to handle larger <code class="docutils literal notranslate"><span class="pre">K</span></code> dimensions. Therefore, we transformed our kernel into a <code class="docutils literal notranslate"><span class="pre">16x6x64</span></code> kernel. The core of the microkernel remained mostly unchanged, except that we updated the input pointers for matrices <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> in each iteration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">A</span></code> is advanced by the given stride to move to the next column.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">B</span></code> is advanced row-by-row, with a 4-byte step for each 32-bit float value.</p></li>
</ul>
<p>The updated loop body is shown below:</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">Looping the <code class="docutils literal notranslate"><span class="pre">matmul_16_6_1</span></code> kernel over the <code class="docutils literal notranslate"><span class="pre">K</span></code> dimension</span><a class="headerlink" href="#id25" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 67</span><span class="w">    </span><span class="c1">//  K loop counter</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#64</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="c1">// set start of A</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="c1">// set start of B</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="c1">// init row count of B</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="nl">_k_loop:</span>
<span class="linenos"> 77</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q24</span><span class="p">,</span><span class="w"> </span><span class="no">q25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q26</span><span class="p">,</span><span class="w"> </span><span class="no">q27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">122</span>
<span class="linenos">123</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">125</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">126</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">132</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">133</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k_loop</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">matmul_16_6_1</span></code> kernel mostly stayed the same, except that for each K loop, we now need to adjust the pointers to the input matrices A and B. At the end of each loop, we move the pointers to A to the next column by adding the given stride. In B, we need to move the pointer to the next row. Therefore, we jump by 4 Bytes (since we are using 32-bit floats) from the starting address of B. To keep jumping to the next row in each loop, we accumulate the offset of 4 Bytes in the register <code class="docutils literal notranslate"><span class="pre">x9</span></code>.</p>
<p>In the <strong>second</strong> step we added a loop over the <code class="docutils literal notranslate"><span class="pre">M</span></code> dimension to build a <code class="docutils literal notranslate"><span class="pre">64x6x64</span></code> kernel. In this version, we reused the kernel for processing 16 rows of <code class="docutils literal notranslate"><span class="pre">M</span></code> at a time and iterated four times to cover all 64 rows. That means, at the end of the <code class="docutils literal notranslate"><span class="pre">M</span></code> loop, we advance the pointers of <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code> to the next block.</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">First part of looping over the <code class="docutils literal notranslate"><span class="pre">M</span></code> dimension</span><a class="headerlink" href="#id26" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">45</span><span class="w">    </span><span class="c1">// save base matrix pointers</span>
<span class="linenos">46</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">48</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="c1">// C</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="w">    </span><span class="c1">// M loop counter</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span><span class="w"> </span><span class="c1">// 64/16 = 4 blocks</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="nl">_m_loop:</span>
<span class="linenos">54</span><span class="c1">// ------------------------------------------</span>
<span class="linenos">55</span><span class="c1">// START matmul_16_6_64</span>
<span class="linenos">56</span><span class="c1">// ------------------------------------------</span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">    </span><span class="c1">// LOAD MATRIX C</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">60</span><span class="w">    </span><span class="c1">// first column</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q0</span><span class="p">,</span><span class="w"> </span><span class="no">q1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">62</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q2</span><span class="p">,</span><span class="w"> </span><span class="no">q3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">63</span><span class="w">    </span><span class="c1">// second column</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">65</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q4</span><span class="p">,</span><span class="w"> </span><span class="no">q5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">66</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q6</span><span class="p">,</span><span class="w"> </span><span class="no">q7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">67</span><span class="w">    </span><span class="c1">// third column</span>
<span class="linenos">68</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">69</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q8</span><span class="p">,</span><span class="w"> </span><span class="no">q9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">70</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q10</span><span class="p">,</span><span class="w"> </span><span class="no">q11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">71</span><span class="w">    </span><span class="c1">// fourth column</span>
<span class="linenos">72</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">73</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q12</span><span class="p">,</span><span class="w"> </span><span class="no">q13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">74</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q14</span><span class="p">,</span><span class="w"> </span><span class="no">q15</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">75</span><span class="w">    </span><span class="c1">// fifth column</span>
<span class="linenos">76</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">77</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q16</span><span class="p">,</span><span class="w"> </span><span class="no">q17</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">78</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q18</span><span class="p">,</span><span class="w"> </span><span class="no">q19</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">79</span><span class="w">    </span><span class="c1">// sixth column</span>
<span class="linenos">80</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">81</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q20</span><span class="p">,</span><span class="w"> </span><span class="no">q21</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">82</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q22</span><span class="p">,</span><span class="w"> </span><span class="no">q23</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">83</span>
<span class="linenos">84</span><span class="w">    </span><span class="c1">// K loop counter</span>
<span class="linenos">85</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x14</span><span class="p">,</span><span class="w"> </span><span class="mi">#64</span>
<span class="linenos">86</span><span class="w">    </span><span class="c1">// set start of A</span>
<span class="linenos">87</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x15</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span>
<span class="linenos">88</span><span class="w">    </span><span class="c1">// set start of B</span>
<span class="linenos">89</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x16</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span>
<span class="linenos">90</span><span class="w">    </span><span class="c1">// init row count of B</span>
<span class="linenos">91</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span>
<span class="linenos">92</span><span class="nl">_k_loop:</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">Second part of looping over the <code class="docutils literal notranslate"><span class="pre">M</span></code> dimension</span><a class="headerlink" href="#id27" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">153</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">154</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x14</span><span class="p">,</span><span class="w"> </span><span class="no">_k_loop</span>
<span class="linenos">155</span>
<span class="linenos">156</span><span class="w">    </span><span class="c1">// STORE MATRIX C</span>
<span class="linenos">157</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">// first column</span>
<span class="linenos">159</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q0</span><span class="p">,</span><span class="w"> </span><span class="no">q1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">160</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q2</span><span class="p">,</span><span class="w"> </span><span class="no">q3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">// second column</span>
<span class="linenos">162</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">163</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q4</span><span class="p">,</span><span class="w"> </span><span class="no">q5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">164</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q6</span><span class="p">,</span><span class="w"> </span><span class="no">q7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">165</span><span class="w">    </span><span class="c1">// third column</span>
<span class="linenos">166</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">167</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q8</span><span class="p">,</span><span class="w"> </span><span class="no">q9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">168</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q10</span><span class="p">,</span><span class="w"> </span><span class="no">q11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">169</span><span class="w">    </span><span class="c1">// fourth column</span>
<span class="linenos">170</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">171</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q12</span><span class="p">,</span><span class="w"> </span><span class="no">q13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">172</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q14</span><span class="p">,</span><span class="w"> </span><span class="no">q15</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">173</span><span class="w">    </span><span class="c1">// fifth column</span>
<span class="linenos">174</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">175</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q16</span><span class="p">,</span><span class="w"> </span><span class="no">q17</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">176</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q18</span><span class="p">,</span><span class="w"> </span><span class="no">q19</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">177</span><span class="w">    </span><span class="c1">// sixth column</span>
<span class="linenos">178</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">179</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q20</span><span class="p">,</span><span class="w"> </span><span class="no">q21</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">180</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q22</span><span class="p">,</span><span class="w"> </span><span class="no">q23</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">181</span>
<span class="linenos">182</span><span class="c1">// ------------------------------------------</span>
<span class="linenos">183</span><span class="c1">// END matmul_16_6_64</span>
<span class="linenos">184</span><span class="c1">// ------------------------------------------</span>
<span class="linenos">185</span>
<span class="linenos">186</span><span class="w">    </span><span class="c1">// increase A and C pointers for next block</span>
<span class="linenos">187</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span><span class="p">*</span><span class="mi">4</span>
<span class="linenos">188</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span><span class="p">*</span><span class="mi">4</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="w">    </span><span class="c1">// decrement m loop counter</span>
<span class="linenos">191</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">192</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">193</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">_m_loop</span>
</pre></div>
</div>
</div>
<p>The <strong>third</strong> step was to implement a loop in the N dimension, extending the kernel to handle a <code class="docutils literal notranslate"><span class="pre">64x48x64</span></code> matrix multiplication. This required dividing <code class="docutils literal notranslate"><span class="pre">N</span></code> into 8 blocks of 6 columns, resulting in 8 loop iterations. For each <code class="docutils literal notranslate"><span class="pre">N</span></code> loop, it is important to first reset the pointer of <code class="docutils literal notranslate"><span class="pre">A</span></code> to the original address. After each iteration, we need to move the pointers of <code class="docutils literal notranslate"><span class="pre">B</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code> to the next block:</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">First part of looping over the <code class="docutils literal notranslate"><span class="pre">N</span></code> dimension</span><a class="headerlink" href="#id28" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">49</span><span class="w">    </span><span class="c1">// set base matrix pointers</span>
<span class="linenos">50</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x20</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x21</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="c1">// C</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="w">    </span><span class="c1">// N loop counter</span>
<span class="linenos">54</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">#8</span><span class="w"> </span><span class="c1">// 48/6 = 8 blocks</span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="nl">_n_loop:</span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">    </span><span class="c1">// M loop counter</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span><span class="w"> </span><span class="c1">// 64/16 = 4 blocks</span>
<span class="linenos">60</span>
<span class="linenos">61</span><span class="w">    </span><span class="c1">// set matrix pointers</span>
<span class="linenos">62</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x20</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x21</span><span class="w"> </span><span class="c1">// C</span>
<span class="linenos">65</span>
<span class="linenos">66</span><span class="nl">_m_loop:</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">Second part of looping over the <code class="docutils literal notranslate"><span class="pre">N</span></code> dimension</span><a class="headerlink" href="#id29" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">205</span><span class="w">    </span><span class="c1">// decrement m loop counter</span>
<span class="linenos">206</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">207</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">208</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">_m_loop</span>
<span class="linenos">209</span><span class="c1">// END M LOOP</span>
<span class="linenos">210</span>
<span class="linenos">211</span><span class="w">    </span><span class="c1">// increase B and C pointers for next block</span>
<span class="linenos">212</span><span class="w">    </span><span class="c1">// (jump 6 columns) 6*x4, 6*x5</span>
<span class="linenos">213</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x20</span><span class="p">,</span><span class="w"> </span><span class="no">x20</span><span class="p">,</span><span class="w"> </span><span class="no">x22</span>
<span class="linenos">214</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x21</span><span class="p">,</span><span class="w"> </span><span class="no">x21</span><span class="p">,</span><span class="w"> </span><span class="no">x23</span>
<span class="linenos">215</span>
<span class="linenos">216</span><span class="w">    </span><span class="c1">// decrement n loop counter</span>
<span class="linenos">217</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">218</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">219</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="no">_n_loop</span>
<span class="linenos">220</span><span class="c1">// END N LOOP</span>
</pre></div>
</div>
</div>
</section>
<section id="id5">
<h3>3.3.2 Testing and Benchmarking<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<p>To ensure correctness, we wrote unit tests for all three of our kernels. To execute the tests, we need to step in the correct directory (<code class="docutils literal notranslate"><span class="pre">src/submissions/03_neon/03_loops</span></code>) and compile the code by invoking <code class="docutils literal notranslate"><span class="pre">make</span></code>. This will create an executable that can be run with <code class="docutils literal notranslate"><span class="pre">./build/test</span></code>.</p>
<p>We also benchmarked each kernel to measure their performance in <code class="docutils literal notranslate"><span class="pre">GFLOPs</span></code>, using the standard formula:</p>
<div class="math notranslate nohighlight">
\[M \cdot N \cdot K \cdot \text{Ops Per FMLA}\]</div>
<p>The benchmarking results that we obtained are:</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">GFLOPs</span></code> calculations for the MatMul kernels</span><a class="headerlink" href="#id30" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking Matmul_16_6_64 throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for Instruction
<span class="linenos"> 4</span>Total time (s):   1.89248
<span class="linenos"> 5</span>Instructions per Second:   1.29861e+11
<span class="linenos"> 6</span>Estimated GFLOPS:   129.861 GFLOPS/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking Matmul_64_6_64 Matmul throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for Instruction
<span class="linenos">12</span>Total time (s):   1.84635
<span class="linenos">13</span>Instructions per Second:   1.33106e+11
<span class="linenos">14</span>Estimated GFLOPS:   133.106 GFLOPS/sec
<span class="linenos">15</span>-----------------------------------------------
<span class="linenos">16</span>
<span class="linenos">17</span>Benchmarking Matmul_64_48_64 Matmul throughput ...
<span class="linenos">18</span>-----------------------------------------------
<span class="linenos">19</span>Measuring throughput for Instruction
<span class="linenos">20</span>Total time (s):   1.49743
<span class="linenos">21</span>Instructions per Second:   1.31297e+11
<span class="linenos">22</span>Estimated GFLOPS:   131.297 GFLOPS/sec
<span class="linenos">23</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Our results indicate that the number of <code class="docutils literal notranslate"><span class="pre">GFLOPs</span></code> is very consistent, even when scaling the size of our matrices.</p>
</section>
</section>
<section id="simd-lanes">
<span id="simd"></span><h2>3.4 SIMD Lanes<a class="headerlink" href="#simd-lanes" title="Link to this heading"></a></h2>
<p>In this task, our goal was to implement two kernels capable of handling cases where the <code class="docutils literal notranslate"><span class="pre">M</span></code> dimension is not a multiple of 4. Specifically, we focused on the following matrix shapes:</p>
<ol class="arabic simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">M=14</span></code>, <code class="docutils literal notranslate"><span class="pre">N=6</span></code> and <code class="docutils literal notranslate"><span class="pre">K=64</span></code>, and</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">M=15</span></code>, <code class="docutils literal notranslate"><span class="pre">N=6</span></code> and <code class="docutils literal notranslate"><span class="pre">K=64</span></code></p></li>
</ol>
<section id="matmul-14-6-64">
<h3>3.4.1 Matmul_14_6_64<a class="headerlink" href="#matmul-14-6-64" title="Link to this heading"></a></h3>
<p>For the case <code class="docutils literal notranslate"><span class="pre">M=14</span></code>, we explored four different implementations:</p>
<p>In our <strong>first approach</strong> we used two loops. The first loop computes a <code class="docutils literal notranslate"><span class="pre">12</span> <span class="pre">x</span> <span class="pre">64</span></code> block of matrix C, while the second loop handles the remaining <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">x</span> <span class="pre">64</span></code> block.</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">Second loop for the <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">x</span> <span class="pre">64</span></code> matrix calculation</span><a class="headerlink" href="#id31" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">157</span><span class="nl">_k2_loop:</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos">159</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d24</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w">   </span><span class="c1">// 2 values</span>
<span class="linenos">160</span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos">162</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">163</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">166</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">167</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">168</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">169</span>
<span class="linenos">170</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">171</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">172</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">173</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">174</span>
<span class="linenos">175</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">176</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">177</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">178</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">179</span>
<span class="linenos">180</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">181</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">182</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">183</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">184</span><span class="w">    </span>
<span class="linenos">185</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">186</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">187</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">188</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">191</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">192</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">193</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">194</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">195</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">196</span>
<span class="linenos">197</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">198</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">199</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">200</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k2_loop</span>
</pre></div>
</div>
</div>
<p>For our <strong>second approach</strong> we used a single loop. Here, we load the entire matrix <code class="docutils literal notranslate"><span class="pre">C</span></code> and process each column of <code class="docutils literal notranslate"><span class="pre">A</span></code> in a loop iteration using three <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(4s)</span></code> instructions and one <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(2s)</span></code> instruction.</p>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">Calculating matrix <code class="docutils literal notranslate"><span class="pre">C</span></code> with a single loop using different calculations</span><a class="headerlink" href="#id32" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 86</span><span class="nl">_k1_loop:</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q24</span><span class="p">,</span><span class="w"> </span><span class="no">q25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q26</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 values</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#48</span><span class="p">]</span><span class="w"> </span><span class="c1">// 2 values</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">122</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">126</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">129</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">132</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">133</span>
<span class="linenos">134</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">136</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">137</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">138</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">139</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">140</span>
<span class="linenos">141</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">142</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">143</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">144</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>In our <strong>third approach</strong> we were also using the single loop version, but this time we padded a register of <code class="docutils literal notranslate"><span class="pre">A</span></code>, that holds the remaining two values with two zero values using <code class="docutils literal notranslate"><span class="pre">mov</span> <span class="pre">v27.s[2],</span> <span class="pre">wzr</span></code> and <code class="docutils literal notranslate"><span class="pre">mov</span> <span class="pre">v27.s[3],</span> <span class="pre">wzr</span></code>. This allows us to use four <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(4s)</span></code> instructions.</p>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">Using zero-padding to use four <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(4s)</span></code> instructions</span><a class="headerlink" href="#id33" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 88</span><span class="nl">_k1_loop:</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q24</span><span class="p">,</span><span class="w"> </span><span class="no">q25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q26</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 values</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#48</span><span class="p">]</span><span class="w"> </span><span class="c1">// 2 values</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="no">wzr</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="no">wzr</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">103</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">110</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">122</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">124</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">126</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">129</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">131</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">132</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">133</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">134</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">136</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">137</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">138</span>
<span class="linenos">139</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">140</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">141</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">142</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">143</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">144</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">145</span>
<span class="linenos">146</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">147</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">148</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">149</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>In our <strong>fourth approach</strong> we simply copied the second version and changed our loads for matrix A and C. We used <code class="docutils literal notranslate"><span class="pre">ld1</span></code> instead of <code class="docutils literal notranslate"><span class="pre">ldp</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">Single loop version using <code class="docutils literal notranslate"><span class="pre">ld1</span></code> loads</span><a class="headerlink" href="#id34" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 73</span><span class="nl">_k1_loop:</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v24.4s-v27.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#48</span><span class="p">]</span><span class="w"> </span><span class="c1">// 2 values</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">122</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">129</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>To compare our different versions, we performed benchmarks on each kernel. Our benchmarking results are as follows:</p>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for <code class="docutils literal notranslate"><span class="pre">matmul_14_6_64</span></code> approaches</span><a class="headerlink" href="#id35" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking V1_Matmul_14_6_64 throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for Instruction
<span class="linenos"> 4</span>Total time (s):   2.46349
<span class="linenos"> 5</span>Instructions per Second:   8.72907e+10
<span class="linenos"> 6</span>Estimated GFLOPS:   87.2907 GFLOPS/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking V2_Matmul_14_6_64 throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for Instruction
<span class="linenos">12</span>Total time (s):   1.86679
<span class="linenos">13</span>Instructions per Second:   1.15192e+11
<span class="linenos">14</span>Estimated GFLOPS:   115.192 GFLOPS/sec
<span class="linenos">15</span>-----------------------------------------------
<span class="linenos">16</span>
<span class="linenos">17</span>Benchmarking V3_Matmul_14_6_64 throughput ...
<span class="linenos">18</span>-----------------------------------------------
<span class="linenos">19</span>Measuring throughput for Instruction
<span class="linenos">20</span>Total time (s):   2.06673
<span class="linenos">21</span>Instructions per Second:   1.04048e+11
<span class="linenos">22</span>Estimated GFLOPS:   104.048 GFLOPS/sec
<span class="linenos">23</span>-----------------------------------------------
<span class="linenos">24</span>
<span class="linenos">25</span>Benchmarking V4_Matmul_14_6_64 throughput ...
<span class="linenos">26</span>-----------------------------------------------
<span class="linenos">27</span>Measuring throughput for Instruction
<span class="linenos">28</span>Total time (s):   1.90053
<span class="linenos">29</span>Instructions per Second:   1.13147e+11
<span class="linenos">30</span>Estimated GFLOPS:   113.147 GFLOPS/sec
<span class="linenos">31</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Our results indicate that the second version, using three <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(4s)</span></code> instructions and one <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(2s)</span></code> instruction, achieved the best performance. The version using <code class="docutils literal notranslate"><span class="pre">ld1</span></code> loads achieved a similar <code class="docutils literal notranslate"><span class="pre">GFLOPs</span></code>.</p>
</section>
<section id="matmul-15-6-64">
<h3>3.4.2 Matmul_15_6_64<a class="headerlink" href="#matmul-15-6-64" title="Link to this heading"></a></h3>
<p>For the case <code class="docutils literal notranslate"><span class="pre">M=15</span></code>, we implemented and tested three kernels:</p>
<p>In our <strong>first approach</strong> we similarly to the <code class="docutils literal notranslate"><span class="pre">M=14</span></code> case, split the computation into two loops. The first loop handles a <code class="docutils literal notranslate"><span class="pre">12</span> <span class="pre">x</span> <span class="pre">64</span></code> block, and the second loop processed the remaining <code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">x</span> <span class="pre">64</span></code> block of matrix <code class="docutils literal notranslate"><span class="pre">C</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-text">Second loop for the <code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">x</span> <span class="pre">64</span></code> matrix calculation</span><a class="headerlink" href="#id36" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">211</span><span class="nl">_k2_loop:</span>
<span class="linenos">212</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos">213</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d24</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w">   </span><span class="c1">// 2 values</span>
<span class="linenos">214</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#8</span><span class="p">]</span>
<span class="linenos">215</span>
<span class="linenos">216</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos">217</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">218</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">219</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s1</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s1</span>
<span class="linenos">220</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">221</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">222</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">223</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">224</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s3</span>
<span class="linenos">225</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">226</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">227</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">228</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">229</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s5</span>
<span class="linenos">230</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">231</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">232</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">233</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">234</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s7</span>
<span class="linenos">235</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">236</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">237</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">238</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v8.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">239</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s9</span>
<span class="linenos">240</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">241</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">242</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">243</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">244</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s11</span>
<span class="linenos">245</span>
<span class="linenos">246</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">247</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">248</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">249</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">250</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">251</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">252</span>
<span class="linenos">253</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">254</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">255</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">256</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k2_loop</span>
</pre></div>
</div>
</div>
<p>In the <strong>second approach</strong> we implement the kernel using a single loop. We load matrix <code class="docutils literal notranslate"><span class="pre">A</span></code> column-wise and calculate parts of matrix <code class="docutils literal notranslate"><span class="pre">C</span></code> using four <code class="docutils literal notranslate"><span class="pre">FMLA</span> <span class="pre">(4s)</span></code> instructions. We zeroed out the last element in the final vector register of matrix <code class="docutils literal notranslate"><span class="pre">A</span></code> with <code class="docutils literal notranslate"><span class="pre">mov</span> <span class="pre">v27.s[3],</span> <span class="pre">wzr</span></code> to safely operate on a full register.</p>
<div class="literal-block-wrapper docutils container" id="id37">
<div class="code-block-caption"><span class="caption-text">Single loop version using <code class="docutils literal notranslate"><span class="pre">ldp</span></code> loads</span><a class="headerlink" href="#id37" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">103</span><span class="nl">_k1_loop:</span>
<span class="linenos">104</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q24</span><span class="p">,</span><span class="w"> </span><span class="no">q25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q26</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 values</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#48</span><span class="p">]</span><span class="w"> </span><span class="c1">// 2 values</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#56</span><span class="p">]</span><span class="w"> </span><span class="c1">// 1 value</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="no">wzr</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">120</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">122</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">126</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">127</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">129</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">132</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">133</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">134</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">136</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">137</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">138</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">139</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">140</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">141</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">142</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">143</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">144</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">145</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">146</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">147</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">148</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">149</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">150</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">151</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">152</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">153</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">154</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">155</span>
<span class="linenos">156</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">157</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">159</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">160</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">161</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">162</span>
<span class="linenos">163</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">164</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">165</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">166</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>In the <strong>third approach</strong> we again changed the load instructions from <code class="docutils literal notranslate"><span class="pre">ldp</span></code> to <code class="docutils literal notranslate"><span class="pre">ld1</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id38">
<div class="code-block-caption"><span class="caption-text">Single loop version using <code class="docutils literal notranslate"><span class="pre">ld1</span></code> loads</span><a class="headerlink" href="#id38" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 85</span><span class="nl">_k1_loop:</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v24.4s-v26.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w">  </span><span class="c1">// 12 values</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#48</span><span class="p">]</span><span class="w">         </span><span class="c1">// 2 values</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#56</span><span class="p">]</span><span class="w">         </span><span class="c1">// 1 value</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="no">v28.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="no">wzr</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 96</span><span class="w">    </span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">122</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">126</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">129</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">132</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">133</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">134</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">136</span>
<span class="linenos">137</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">138</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">139</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">140</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">141</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">142</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">143</span>
<span class="linenos">144</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">145</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">146</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">147</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>For these kernels we also executed benchmarks:</p>
<div class="literal-block-wrapper docutils container" id="id39">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for <code class="docutils literal notranslate"><span class="pre">matmul_15_6_64</span></code> approaches</span><a class="headerlink" href="#id39" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">41</span>Benchmarking V1_Matmul_15_6_64 throughput ...
<span class="linenos">42</span>-----------------------------------------------
<span class="linenos">43</span>Measuring throughput for Instruction
<span class="linenos">44</span>Total time (s):   2.57834
<span class="linenos">45</span>Instructions per Second:   8.93599e+10
<span class="linenos">46</span>Estimated GFLOPS:   89.3599 GFLOPS/sec
<span class="linenos">47</span>-----------------------------------------------
<span class="linenos">48</span>
<span class="linenos">49</span>Benchmarking V2_Matmul_15_6_64 throughput ...
<span class="linenos">50</span>-----------------------------------------------
<span class="linenos">51</span>Measuring throughput for Instruction
<span class="linenos">52</span>Total time (s):   2.1093
<span class="linenos">53</span>Instructions per Second:   1.09231e+11
<span class="linenos">54</span>Estimated GFLOPS:   109.231 GFLOPS/sec
<span class="linenos">55</span>-----------------------------------------------
<span class="linenos">56</span>
<span class="linenos">57</span>Benchmarking V3_Matmul_15_6_64 throughput ...
<span class="linenos">58</span>-----------------------------------------------
<span class="linenos">59</span>Measuring throughput for Instruction
<span class="linenos">60</span>Total time (s):   2.10837
<span class="linenos">61</span>Instructions per Second:   1.09279e+11
<span class="linenos">62</span>Estimated GFLOPS:   109.279 GFLOPS/sec
<span class="linenos">63</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Similar to the benchmarks for the <code class="docutils literal notranslate"><span class="pre">matmul_14_6_64</span></code>, the single loop approach significantly outperformed the two loop implementation. In this case, the difference was even bigger, with a gap of approximately <code class="docutils literal notranslate"><span class="pre">20</span> <span class="pre">GFLOPs</span></code>. However, unlike before, changing the load instruction from <code class="docutils literal notranslate"><span class="pre">ldp</span></code> to <code class="docutils literal notranslate"><span class="pre">ld1</span></code> had no impact on the overall performance.</p>
</section>
<section id="generic-approach">
<span id="generic-kernel"></span><h3>3.4.3 Generic Approach<a class="headerlink" href="#generic-approach" title="Link to this heading"></a></h3>
<p>As a proof of concept, we also implemented a generic matrix multiplication kernel capable of handling any <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>. The core idea is to write specific kernels for <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">1,</span> <span class="pre">2,</span> <span class="pre">...,</span> <span class="pre">8</span></code>. For input sizes larger than <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">8</span></code>, we then divide <code class="docutils literal notranslate"><span class="pre">M</span></code> by 8 (shift right by 3) and use that to loop the <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">8</span></code> kernel, which is basically a <code class="docutils literal notranslate"><span class="pre">matmul_8_6_64</span></code> kernel. Any remaining elements (<code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">&lt;=</span> <span class="pre">M</span> <span class="pre">%</span> <span class="pre">8</span> <span class="pre">&lt;=</span> <span class="pre">7</span></code>) are handled by using on of the smaller specialized remainder kernels. To enable this dynamic selection, we employ a jump table that maps the remainder values to their respective kernel entry points.</p>
<p>We also benchmarked the performance of this <strong>generic kernel</strong>:</p>
<div class="literal-block-wrapper docutils container" id="id40">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for <code class="docutils literal notranslate"><span class="pre">matmul_M_6_64</span></code> (<code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">14</span></code>) approach</span><a class="headerlink" href="#id40" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span>Benchmarking Matmul_M_6_64 M=14 throughput ...
<span class="linenos">34</span>-----------------------------------------------
<span class="linenos">35</span>Measuring throughput for Instruction
<span class="linenos">36</span>Total time (s):   2.32252
<span class="linenos">37</span>Instructions per Second:   9.25891e+10
<span class="linenos">38</span>Estimated GFLOPS:   92.5891 GFLOPS/sec
<span class="linenos">39</span>-----------------------------------------------
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id41">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for <code class="docutils literal notranslate"><span class="pre">matmul_M_6_64</span></code> (<code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">15</span></code>) approach</span><a class="headerlink" href="#id41" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">65</span>Benchmarking Matmul_M_6_64 M=15 throughput ...
<span class="linenos">66</span>-----------------------------------------------
<span class="linenos">67</span>Measuring throughput for Instruction
<span class="linenos">68</span>Total time (s):   3.49118
<span class="linenos">69</span>Instructions per Second:   6.59948e+10
<span class="linenos">70</span>Estimated GFLOPS:   65.9948 GFLOPS/sec
<span class="linenos">71</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Compared to our best fixed-size implementations, the generic kernel shows a slightly lower performance, approximately <code class="docutils literal notranslate"><span class="pre">20</span> <span class="pre">GFLOPs</span></code> lower for <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">14</span></code>, and around <code class="docutils literal notranslate"><span class="pre">45</span> <span class="pre">GFLOPs</span></code> lower for <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">15</span></code>. This performance gap is expected due to the overhead of dynamic branching and the generalization of memory access patterns.</p>
</section>
</section>
<section id="accumulator-block-shapes">
<span id="id6"></span><h2>3.5 Accumulator Block Shapes<a class="headerlink" href="#accumulator-block-shapes" title="Link to this heading"></a></h2>
<p>In this task, we were supposed to implement a microkernel that computes <code class="docutils literal notranslate"><span class="pre">C+=AB</span></code> for <code class="docutils literal notranslate"><span class="pre">M=64</span></code>, <code class="docutils literal notranslate"><span class="pre">N=64</span></code> and <code class="docutils literal notranslate"><span class="pre">K=64</span></code>.</p>
<p>Starting from our previous <code class="docutils literal notranslate"><span class="pre">matmul_64_48_64</span></code> kernel, we adapted the implementation to support <code class="docutils literal notranslate"><span class="pre">N=64</span></code>. Internally, this kernel relies on a smaller microkernel. In our previous version, we used <code class="docutils literal notranslate"><span class="pre">matmul_16_6_64</span></code>, which we replaced with <code class="docutils literal notranslate"><span class="pre">matmul_16_4_64</span></code>. Reducing <code class="docutils literal notranslate"><span class="pre">N</span></code> from 6 to 4 allows us to split the <code class="docutils literal notranslate"><span class="pre">N</span></code> dimension into 16 blocks of 4 columns. We found that using <code class="docutils literal notranslate"><span class="pre">N=8</span></code> caused issues due to the limited number of available SIMD registers, which made register allocation and performance tuning more difficult.</p>
<p>Since this kernel is very similar to our earlier <code class="docutils literal notranslate"><span class="pre">matmul_64_48_64</span></code> implementation, we chose to not include the code for this kernel here.</p>
<p>The benchmarking results for the new kernel are shown below:</p>
<div class="literal-block-wrapper docutils container" id="id42">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for <code class="docutils literal notranslate"><span class="pre">matmul_64_64_64</span></code> approaches</span><a class="headerlink" href="#id42" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking V1 Matmul throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for Instruction
<span class="linenos"> 4</span>Total time (s):   1.27442
<span class="linenos"> 5</span>Instructions per Second:   1.23418e+11
<span class="linenos"> 6</span>Estimated GFLOPS:   123.418 GFLOPS/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking V2 Matmul throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for Instruction
<span class="linenos">12</span>Total time (s):   1.246
<span class="linenos">13</span>Instructions per Second:   1.26233e+11
<span class="linenos">14</span>Estimated GFLOPS:   126.233 GFLOPS/sec
<span class="linenos">15</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Version V1was directly derived from the <code class="docutils literal notranslate"><span class="pre">matmul_64_48_64</span></code> kernel. Trying to improve its performance, we introduced minor optimizations to the stride calculations and removed unnecessary loads and stores of callee-saved registers that were not used. These adjustments led to a consistent performance improvement of <code class="docutils literal notranslate"><span class="pre">2-3</span> <span class="pre">GFLOPs</span></code>, resulting in version V2.</p>
<p>Below, we compare the naive and the optimized stride calculations:</p>
<div class="literal-block-wrapper docutils container" id="id43">
<div class="code-block-caption"><span class="caption-text">Naive stride calculations</span><a class="headerlink" href="#id43" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">39</span><span class="w">    </span><span class="c1">// multiply strides with float size</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// lda</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// ldb</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// ldc</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">46</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x22</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// ldb * 4 columns</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// ldc * 4 columns</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id44">
<div class="code-block-caption"><span class="caption-text">Optimized stride calculations</span><a class="headerlink" href="#id44" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">37</span><span class="w">    </span><span class="c1">// multiply strides with float size</span>
<span class="linenos">38</span><span class="w">    </span><span class="c1">// *4 = lsl #2</span>
<span class="linenos">39</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// lda</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldb</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldc</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x22</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldb * 4 columns</span>
<span class="linenos">44</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldc * 4 columns</span>
</pre></div>
</div>
</div>
</section>
<section id="batch-reduce-gemm">
<span id="id7"></span><h2>3.6 Batch-Reduce GEMM<a class="headerlink" href="#batch-reduce-gemm" title="Link to this heading"></a></h2>
<p>Based on the previous tasks, we now implement a batch-reduce GEMM (BRGEMM) kernel.
The goal is to implement a kernel that computes the operation <span class="math notranslate nohighlight">\(C+=\sum_i A_i B_i\)</span> for batched matrix inputs, with <code class="docutils literal notranslate"><span class="pre">M=64</span></code>, <code class="docutils literal notranslate"><span class="pre">N=48</span></code>, and <code class="docutils literal notranslate"><span class="pre">K=64</span></code>. The kernel should be able to handle batches of matrices. For now, we restrict the implementation to the case where the batch size is 16.</p>
<p>Similar to the previous tasks, we developed and benchmarked multiple versions of the kernel to optimize for performance.</p>
<p>In our <strong>first version</strong> we used our <code class="docutils literal notranslate"><span class="pre">matmul_64_48_64</span></code> kernel from our <a class="reference internal" href="#loops"><span class="std std-ref">loops section</span></a>. We wrapped it inside a loop that runs 16 times, once for each matrix pair in the batch.
Two key aspects that we addressed were the following:</p>
<div class="literal-block-wrapper docutils container" id="id45">
<div class="code-block-caption"><span class="caption-text">Setting the batch counter</span><a class="headerlink" href="#id45" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="c1">// Batch counter</span>
<span class="nf">mov</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span>

<span class="nl">_n_batch:</span>

<span class="na">...</span>

<span class="nf">sub</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>

<span class="nf">cbnz</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="no">_n_batch</span>
<span class="c1">// END N BATCH</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id46">
<div class="code-block-caption"><span class="caption-text">Jumping to the next matrix <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> in the batch</span><a class="headerlink" href="#id46" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">230</span><span class="w">    </span><span class="c1">// next A matrix</span>
<span class="linenos">231</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos">232</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w">     </span><span class="c1">// A</span>
<span class="linenos">233</span>
<span class="linenos">234</span><span class="w">    </span><span class="c1">// next B matrix</span>
<span class="linenos">235</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">236</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x20</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w">    </span><span class="c1">// B</span>
<span class="linenos">237</span>
<span class="linenos">238</span><span class="w">    </span><span class="c1">// restore Pointer for matrix C</span>
<span class="linenos">239</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x21</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w">    </span><span class="c1">// C</span>
<span class="linenos">240</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x10</span><span class="p">,</span><span class="w"> </span><span class="no">x21</span><span class="w">   </span><span class="c1">// C</span>
<span class="linenos">241</span>
<span class="linenos">242</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">243</span>
<span class="linenos">244</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="no">_n_batch</span>
</pre></div>
</div>
</div>
<p>In our <strong>second version</strong>, we applied some optimizations to the kernel. The changes we made were:</p>
<div class="literal-block-wrapper docutils container" id="id47">
<div class="code-block-caption"><span class="caption-text">Replacing <code class="docutils literal notranslate"><span class="pre">MUL</span></code>’s with <code class="docutils literal notranslate"><span class="pre">LSL</span></code>’s</span><a class="headerlink" href="#id47" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">39</span><span class="w">    </span><span class="c1">// multiply strides with float size</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// lda in bytes</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldb in bytes</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldc in bytes</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// br_stride_a in bytes</span>
<span class="linenos">44</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// br_stride_b in bytes</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id48">
<div class="code-block-caption"><span class="caption-text">Replacing all <code class="docutils literal notranslate"><span class="pre">LDP</span></code>’s with <code class="docutils literal notranslate"><span class="pre">LD1</span></code>’s and <code class="docutils literal notranslate"><span class="pre">STP</span></code>’s with <code class="docutils literal notranslate"><span class="pre">ST1</span></code>’s</span><a class="headerlink" href="#id48" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">78</span><span class="w">    </span><span class="c1">// LOAD MATRIX C</span>
<span class="linenos">79</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x10</span>
<span class="linenos">80</span><span class="w">    </span><span class="c1">// first column</span>
<span class="linenos">81</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">82</span><span class="w">    </span><span class="c1">// second column</span>
<span class="linenos">83</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">84</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">85</span><span class="w">    </span><span class="c1">// third column</span>
<span class="linenos">86</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">87</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">88</span><span class="w">    </span><span class="c1">// fourth column</span>
<span class="linenos">89</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">90</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">91</span><span class="w">    </span><span class="c1">// fifth column</span>
<span class="linenos">92</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">93</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">94</span><span class="w">    </span><span class="c1">// sixth column</span>
<span class="linenos">95</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">96</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>These optimizations resulted in a performance improvement of about <code class="docutils literal notranslate"><span class="pre">3-4</span> <span class="pre">GFLOPs</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id49">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for the batch-reduce GEMM kernels</span><a class="headerlink" href="#id49" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking V1_Matmul_64_48_64_16 throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for Instruction
<span class="linenos"> 4</span>Total time (s):   1.22446
<span class="linenos"> 5</span>Instructions per Second:   1.28453e+11
<span class="linenos"> 6</span>Estimated GFLOPS:   128.453 GFLOPS/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking V2_Matmul_64_48_64_16 throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for Instruction
<span class="linenos">12</span>Total time (s):   1.19946
<span class="linenos">13</span>Instructions per Second:   1.31131e+11
<span class="linenos">14</span>Estimated GFLOPS:   131.131 GFLOPS/sec
</pre></div>
</div>
</div>
</section>
<section id="transposition">
<span id="id8"></span><h2>3.7 Transposition<a class="headerlink" href="#transposition" title="Link to this heading"></a></h2>
<p>In this task, we explored how to transpose an <code class="docutils literal notranslate"><span class="pre">8x8</span></code> matrix using Neon assembly instructions. Our approach was to first develop a solution for the simpler <code class="docutils literal notranslate"><span class="pre">4x4</span></code> case.</p>
<section id="transposition-implementation">
<h3>3.7.1 Transposition Implementation<a class="headerlink" href="#transposition-implementation" title="Link to this heading"></a></h3>
<p>To begin, we loaded all 4 columns of matrix A using <code class="docutils literal notranslate"><span class="pre">ldr</span> <span class="pre">qX,</span> <span class="pre">[x0]</span></code>, so that the entire matrix is placed in our registers. The second step would be to transpose the matrix:</p>
<div class="literal-block-wrapper docutils container" id="id50">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">trans_4_4</span></code> implementation</span><a class="headerlink" href="#id50" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">56</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">57</span><span class="cm">    * Part 2.1:</span>
<span class="linenos">58</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos">59</span><span class="cm">    */</span>
<span class="linenos">60</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos">65</span>
<span class="linenos">66</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">67</span><span class="cm">    * Part 2.2:</span>
<span class="linenos">68</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos">69</span><span class="cm">    */</span>
<span class="linenos">70</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="w">    </span><span class="c1">// B &quot;column&quot; 0</span>
<span class="linenos">71</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="w">    </span><span class="c1">// B &quot;column&quot; 1</span>
<span class="linenos">72</span>
<span class="linenos">73</span><span class="w">    </span><span class="nf">zip2</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="w">   </span><span class="c1">// B &quot;column&quot; 2</span>
<span class="linenos">74</span><span class="w">    </span><span class="nf">zip2</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="w">   </span><span class="c1">// B &quot;column&quot; 3</span>
</pre></div>
</div>
</div>
<p>The idea of <code class="docutils literal notranslate"><span class="pre">trn1</span></code> and <code class="docutils literal notranslate"><span class="pre">trn2</span></code> is to prepare the elements for each column, so that
we can then leverage their new structure using <code class="docutils literal notranslate"><span class="pre">zip1</span></code> and <code class="docutils literal notranslate"><span class="pre">zip2</span></code>.</p>
<p>To scale this to an <code class="docutils literal notranslate"><span class="pre">8x8</span></code> matrix, we divided the matrix into four <code class="docutils literal notranslate"><span class="pre">4x4</span></code> submatrices:</p>
<a class="reference internal image-reference" href="../_images/submatrices.png"><img alt="Matrix divided in four quadrants" src="../_images/submatrices.png" style="width: 400px;" />
</a>
<p>Each quadrant was transposed independently using our <code class="docutils literal notranslate"><span class="pre">trans_4_4</span></code> kernel:</p>
<ol class="arabic simple">
<li><p>The upper-left matrix (in the image A) was transposed and stored at the same position.</p></li>
<li><p>The upper-right matrix (in the image B) was transposed and stored into the position originally occupied by the bottom-left matrix.</p></li>
<li><p>The bottom-left matrix (in the image C) would be transposed and stored into the position originally occupied by the upper-right matrix.</p></li>
<li><p>The bottom-right matrix (in the image D) was transposed and stored at the same position.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id51">
<div class="code-block-caption"><span class="caption-text">Transposing and swapping upper-right and bottom-left submatrices</span><a class="headerlink" href="#id51" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 89</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 90</span><span class="cm">    * Part 1.2:</span>
<span class="linenos"> 91</span><span class="cm">    * Load 4x4 block of A (Left bottom, top right).</span>
<span class="linenos"> 92</span><span class="cm">    */</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="w">    </span><span class="c1">// Right top</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#128</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#128</span>
<span class="linenos">113</span><span class="w">    </span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q15</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">121</span>
<span class="linenos">122</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">123</span><span class="cm">    * Part 2.1:</span>
<span class="linenos">124</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos">125</span><span class="cm">    */</span>
<span class="linenos">126</span><span class="w">    </span><span class="c1">// Left Bottom</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos">132</span>
<span class="linenos">133</span><span class="w">    </span><span class="c1">// Right Top</span>
<span class="linenos">134</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span>
<span class="linenos">136</span>
<span class="linenos">137</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span>
<span class="linenos">138</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span>
<span class="linenos">139</span>
<span class="linenos">140</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">141</span><span class="cm">    * Part 2.2:</span>
<span class="linenos">142</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos">143</span><span class="cm">    */</span>
<span class="linenos">144</span><span class="w">    </span><span class="c1">// Left Bottom</span>
<span class="linenos">145</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="w">    </span>
<span class="linenos">146</span><span class="w">    </span><span class="no">zip1</span><span class="w"> </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="w">    </span>
<span class="linenos">147</span>
<span class="linenos">148</span><span class="w">    </span><span class="no">zip2</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="w">   </span>
<span class="linenos">149</span><span class="w">    </span><span class="no">zip2</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="w">   </span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="w">    </span><span class="c1">// Right Top</span>
<span class="linenos">152</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span><span class="w"> </span>
<span class="linenos">153</span><span class="w">    </span><span class="no">zip1</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span><span class="w"> </span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="w">    </span><span class="no">zip2</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span><span class="w"> </span>
<span class="linenos">156</span><span class="w">    </span><span class="no">zip2</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span>
<span class="linenos">157</span>
<span class="linenos">158</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">159</span><span class="cm">    * Part 3:</span>
<span class="linenos">160</span><span class="cm">    * Store 4x4 block of Submatrix A&#39;&#39;&#39; into A&#39;&#39;.</span>
<span class="linenos">161</span><span class="cm">    */</span>
<span class="linenos">162</span><span class="w">    </span><span class="c1">// Left Bottom (values from right top)</span>
<span class="linenos">163</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">164</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span>
<span class="linenos">165</span>
<span class="linenos">166</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q20</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">167</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">168</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q21</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">169</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">170</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q22</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">171</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">172</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q23</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">173</span>
<span class="linenos">174</span><span class="w">    </span><span class="c1">// Right top (values from left bottom)</span>
<span class="linenos">175</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">176</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#128</span>
<span class="linenos">177</span>
<span class="linenos">178</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">179</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">180</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">181</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">182</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">183</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">184</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>To optimize our initial implementation, we removed the PCS for all regsiters that we didn’t use.
We also restructured our code for clarity and compactness.</p>
<div class="literal-block-wrapper docutils container" id="id52">
<div class="code-block-caption"><span class="caption-text">Optimized second version of the transposition kernel</span><a class="headerlink" href="#id52" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 40</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// n loop</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="nl">n_loop:</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// m loop</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="nl">m_loop:</span>
<span class="linenos"> 47</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 48</span><span class="cm">     * Part 1:</span>
<span class="linenos"> 49</span><span class="cm">     * Transpose 4x4 block.</span>
<span class="linenos"> 50</span><span class="cm">     */</span>
<span class="linenos"> 51</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 52</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 55</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 66</span><span class="cm">    * Part 2.1:</span>
<span class="linenos"> 67</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos"> 68</span><span class="cm">    */</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 76</span><span class="cm">    * Part 2.2:</span>
<span class="linenos"> 77</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos"> 78</span><span class="cm">    */</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="nf">zip2</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="nf">zip2</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 86</span><span class="cm">    * Part 3:</span>
<span class="linenos"> 87</span><span class="cm">    * Store 4x4 block of A into B.</span>
<span class="linenos"> 88</span><span class="cm">    */</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q16</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q17</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q18</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q19</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="w">    </span><span class="c1">// Jump 4 rows in A</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x25</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="w">    </span><span class="c1">// Jump 4 columns in B</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x27</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">m_loop</span>
<span class="linenos">108</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="w">    </span><span class="c1">// Restore Pointer for A and B</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">113</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x26</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x13</span><span class="p">,</span><span class="w"> </span><span class="no">x13</span><span class="p">,</span><span class="w"> </span><span class="no">x25</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x13</span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">n_loop</span>
</pre></div>
</div>
</div>
</section>
<section id="performance-measuring">
<h3>3.7.2 Performance Measuring<a class="headerlink" href="#performance-measuring" title="Link to this heading"></a></h3>
<p>We measured the throughput of our transposition kernel in terms of memory transfer speed, since the core performance factor in this case is loading and storing elements efficiently.</p>
<div class="literal-block-wrapper docutils container" id="id53">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">trans_8_8</span></code> performance in <code class="docutils literal notranslate"><span class="pre">GiB/s</span></code></span><a class="headerlink" href="#id53" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking trans_neon_8_8 performance ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for transposition in GiB/s
<span class="linenos"> 4</span>Total time (s):   1.26545
<span class="linenos"> 5</span>Data movements per Second:   8.09199e+10
<span class="linenos"> 6</span>Estimated GiB/s:   80.9199 GiB/s
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking v2_trans_neon_8_8 performance ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for transposition in GiB/s
<span class="linenos">12</span>Total time (s):   0.902975
<span class="linenos">13</span>Data movements per Second:   1.13403e+11
<span class="linenos">14</span>Estimated GiB/s:   113.403 GiB/s
<span class="linenos">15</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Our benchmarking results show that the initial version achieved approximately <code class="docutils literal notranslate"><span class="pre">81</span> <span class="pre">GiB/s</span></code>. With our optimizations, we increased this to about <code class="docutils literal notranslate"><span class="pre">113</span> <span class="pre">GiB/s</span></code>.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="02_base.html" class="btn btn-neutral float-left" title="2. Base" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="04_code_gen.html" class="btn btn-neutral float-right" title="4. Code Generation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lucas Obitz, Luca-Philipp Grumbach.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>